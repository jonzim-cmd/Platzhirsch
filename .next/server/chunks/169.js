exports.id=169,exports.ids=[169],exports.modules={9363:(e,t,a)=>{let r={"1aad7720052bcbb3c3fff8073038f2a189fc9f98":()=>Promise.resolve().then(a.bind(a,1803)).then(e=>e.deleteClass),"4c018bc9b36e8e4ee0c64573afa34673fa514a06":()=>Promise.resolve().then(a.bind(a,1803)).then(e=>e.createClass),"7914dc5fbc064000e9e7e67beeae2d6d76de8861":()=>Promise.resolve().then(a.bind(a,1803)).then(e=>e.setClassLead),b1a86aeaa537ef061ece06ae838f0f0fbfb3aa3d:()=>Promise.resolve().then(a.bind(a,1803)).then(e=>e.listClasses),"51a097bff94b6d7bde5cfb7a76cc419ca2d2d897":()=>Promise.resolve().then(a.bind(a,1379)).then(e=>e.createRoom),"88a28fa01bf8eb3ed6954f8a4f4ae43143c0f7e0":()=>Promise.resolve().then(a.bind(a,1379)).then(e=>e.deleteRoom),"8a57dfb094cf75dda1cd39da095655f2cc8d362e":()=>Promise.resolve().then(a.bind(a,1379)).then(e=>e.listRooms)};async function i(e,...t){return(await r[e]()).apply(null,t)}e.exports={"1aad7720052bcbb3c3fff8073038f2a189fc9f98":i.bind(null,"1aad7720052bcbb3c3fff8073038f2a189fc9f98"),"4c018bc9b36e8e4ee0c64573afa34673fa514a06":i.bind(null,"4c018bc9b36e8e4ee0c64573afa34673fa514a06"),"7914dc5fbc064000e9e7e67beeae2d6d76de8861":i.bind(null,"7914dc5fbc064000e9e7e67beeae2d6d76de8861"),b1a86aeaa537ef061ece06ae838f0f0fbfb3aa3d:i.bind(null,"b1a86aeaa537ef061ece06ae838f0f0fbfb3aa3d"),"51a097bff94b6d7bde5cfb7a76cc419ca2d2d897":i.bind(null,"51a097bff94b6d7bde5cfb7a76cc419ca2d2d897"),"88a28fa01bf8eb3ed6954f8a4f4ae43143c0f7e0":i.bind(null,"88a28fa01bf8eb3ed6954f8a4f4ae43143c0f7e0"),"8a57dfb094cf75dda1cd39da095655f2cc8d362e":i.bind(null,"8a57dfb094cf75dda1cd39da095655f2cc8d362e")}},9371:(e,t,a)=>{Promise.resolve().then(a.bind(a,496))},496:(e,t,a)=>{"use strict";a.d(t,{Editor:()=>y});var r=a(326),i=a(7577);function n(e,t,a,r){let i=Math.max(0,Math.min(1,r));return"left"===a?{left:-12,top:t*i-12}:"right"===a?{left:e-12,top:t*i-12}:"top"===a?{left:e*i-12,top:-12}:{left:e*i-12,top:t-12}}function l(e,t){let a=Math.max(0,Math.min(e.y+e.h,t.y+t.h)-Math.max(e.y,t.y)),r=Math.max(0,Math.min(e.x+e.w,t.x+t.w)-Math.max(e.x,t.x));if(a>0){if(.75>=Math.abs(e.x+e.w-t.x)){let a=Math.max(e.y,t.y),r=Math.min(e.y+e.h,t.y+t.h);return{aSide:"right",bSide:"left",aT:((a+r)/2-e.y)/e.h,bT:((a+r)/2-t.y)/t.h}}if(.75>=Math.abs(e.x-(t.x+t.w))){let a=Math.max(e.y,t.y),r=Math.min(e.y+e.h,t.y+t.h);return{aSide:"left",bSide:"right",aT:((a+r)/2-e.y)/e.h,bT:((a+r)/2-t.y)/t.h}}}if(r>0){if(.75>=Math.abs(e.y+e.h-t.y)){let a=Math.max(e.x,t.x),r=Math.min(e.x+e.w,t.x+t.w);return{aSide:"bottom",bSide:"top",aT:((a+r)/2-e.x)/e.w,bT:((a+r)/2-t.x)/t.w}}if(.75>=Math.abs(e.y-(t.y+t.h))){let a=Math.max(e.x,t.x),r=Math.min(e.x+e.w,t.x+t.w);return{aSide:"top",bSide:"bottom",aT:((a+r)/2-e.x)/e.w,bT:((a+r)/2-t.x)/t.w}}}let i=e.x+e.w/2,n=e.y+e.h/2,l=t.x+t.w/2,d=t.y+t.h/2,s=l-i,o=d-n;if(Math.abs(s)>Math.abs(o)){let a=Math.max(e.y,t.y),r=Math.min(e.y+e.h,t.y+t.h),i=((a+r)/2-e.y)/e.h,n=((a+r)/2-t.y)/t.h;return s>0?{aSide:"right",bSide:"left",aT:i,bT:n}:{aSide:"left",bSide:"right",aT:i,bT:n}}{let a=Math.max(e.x,t.x),r=Math.min(e.x+e.w,t.x+t.w),i=((a+r)/2-e.x)/e.w,n=((a+r)/2-t.x)/t.w;return o>0?{aSide:"bottom",bSide:"top",aT:i,bT:n}:{aSide:"top",bSide:"bottom",aT:i,bT:n}}}var d=a(2816),s=a(3679),o=a(9418);function h({elements:e,readOnly:t,onDetach:a,hoverCandidate:i,onCreate:l}){return t?null:(0,r.jsxs)("div",{className:"pointer-events-none absolute inset-0",style:{zIndex:o.Z.overlay},children:[i&&(()=>{let t=e.find(e=>e.id===i.aId);if(!t)return null;let a=n(t.w,t.h,i.aSide,"number"==typeof i.aT?i.aT:.5),d=t.x+a.left,s=t.y+a.top;return r.jsx("button",{type:"button",title:"Heftung erstellen",className:"absolute pointer-events-auto h-6 w-6 flex items-center justify-center text-neutral-500 hover:text-neutral-50",style:{left:d,top:s},onClick:e=>{e.stopPropagation(),l?.(i)},children:(0,r.jsxs)("svg",{viewBox:"0 0 24 24",className:"h-4 w-4",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"drop-shadow(0 0 1px rgba(0,0,0,0.85))"},children:[r.jsx("path",{d:"M8 11V8a4 4 0 118 0v3"}),r.jsx("rect",{x:"6.5",y:"11",width:"11",height:"8",rx:"2"})]})})})(),e.flatMap(e=>{let t=e.id;return(Array.isArray(e.meta?.joints)?e.meta.joints:[]).filter(e=>(t||"")<(e.otherId||"")).map(i=>{let l=n(e.w,e.h,i.side,"number"==typeof i.t?i.t:.5),d=e.x+l.left,s=e.y+l.top;return r.jsx("button",{type:"button",title:"Heftung l\xf6sen",className:"absolute pointer-events-auto h-6 w-6 flex items-center justify-center text-neutral-200 hover:text-neutral-50",style:{left:d,top:s},onClick:e=>{e.stopPropagation(),a(t,i.otherId)},children:(0,r.jsxs)("svg",{viewBox:"0 0 24 24",className:"h-4 w-4",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"drop-shadow(0 0 1px rgba(0,0,0,0.85))"},children:[r.jsx("path",{d:"M8 11V8a4 4 0 118 0v3"}),r.jsx("rect",{x:"6.5",y:"11",width:"11",height:"8",rx:"2"}),r.jsx("path",{d:"M12 14v2"})]})},`${t}-${i.otherId}`)})})]})}var u=a(962);function f({children:e}){return"undefined"==typeof document?null:(0,u.createPortal)(e,document.body)}function c({ctx:e}){let{leadPlan:t,viewMode:a,setViewMode:i,saving:n,frameRef:l,canvasRef:u,frameSize:c,readOnly:m,elements:x,selectedIds:p,setSelectedIds:y,elementRefs:b,selected:w,studentById:g,defaultTerms:M,pickerOpenId:I,setPickerOpenId:S,pickerQuery:v,setPickerQuery:j,usedStudentIds:N,addElement:T,applyPairsLayout:E,removeJoint:D,scheduleSave:A,exportPng:z,exportPdf:C,selectedTarget:k,primarySelectedId:P,moveElementBy:R,onDragEnd:L,setElements:_,students:O,classId:W,roomId:U,loadPlan:$}=e;return(0,r.jsxs)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-5",children:[(0,r.jsxs)("div",{className:"lg:col-span-5 h-[calc(100vh-48px)] rounded border border-neutral-900 bg-neutral-950/40 relative",children:[(0,r.jsxs)("div",{className:"pointer-events-auto absolute right-3 top-3 flex items-center gap-2 text-xs",style:{zIndex:o.Z.toolbar},children:[t&&(0,r.jsxs)("div",{className:"ml-2 flex items-center gap-2",children:[r.jsx("span",{className:"text-fg-muted",children:"Ansicht:"}),r.jsx(s.z,{onClick:()=>i("owner"),className:"owner"===a?"bg-primary/20 text-primary":"",children:"Eigen"}),r.jsx(s.z,{onClick:()=>i("lead"),className:"lead"===a?"bg-primary/20 text-primary":"",children:"KL"})]}),(0,r.jsxs)("div",{className:"text-fg-muted",children:["saving"===n&&r.jsx("span",{className:"ml-3",children:"Speichern…"}),"saved"===n&&r.jsx("span",{className:"ml-3 text-primary",children:"Gespeichert"})]})]}),r.jsx("div",{ref:l,className:"relative h-full w-full overflow-auto",children:(0,r.jsxs)("div",{ref:u,className:"relative",style:{width:c.w,height:c.h},onMouseDown:t=>{if(!m&&t.target===u.current){let a=t.currentTarget.getBoundingClientRect(),r=t.clientX-a.left,i=t.clientY-a.top;if("function"==typeof e.tryCreateJointAt&&e.tryCreateJointAt(r,i))return;e.setMarquee({active:!0,x0:r,y0:i,x1:r,y1:i}),y([]);let n=t=>{let n=t.clientX-a.left,l=t.clientY-a.top;e.setMarquee(e=>({...e,x1:n,y1:l}));let d=Math.min(r,n),s=Math.min(i,l),o=Math.max(r,n),h=Math.max(i,l),u=(e,t,a,r,i,n,l,d)=>!(a<i||e>l||r<n||t>d);y(x.filter(e=>{let t=((e.rotation||0)%360+360)%360*Math.PI/180,a=Math.cos(t),r=Math.sin(t),i=Math.abs(e.w*a)+Math.abs(e.h*r),n=Math.abs(e.w*r)+Math.abs(e.h*a),l=e.x+e.w/2,f=e.y+e.h/2,c=l-i/2,m=f-n/2,x=l+i/2,p=f+n/2;return"DOOR"===e.type||"WINDOW_SIDE"===e.type||"WALL_SIDE"===e.type?u(c,m,x,p,d,s,o,h):c>=d&&m>=s&&x<=o&&p<=h}).map(e=>e.id))},l=t=>{let r=t.clientX-a.left,i=t.clientY-a.top;e.setMarquee(e=>({...e,active:!1,x1:r,y1:i})),window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",l)};window.addEventListener("mousemove",n),window.addEventListener("mouseup",l)}},onMouseMove:t=>{if(m||!u.current)return;let a=t.currentTarget.getBoundingClientRect(),r=t.clientX-a.left,i=t.clientY-a.top;e.updateJointHover?.(r,i)},onMouseLeave:()=>{m||e.setJointHover?.(null)},children:[("owner"===a?x:t?.elements||[]).map(t=>r.jsx("div",{role:"button",onMouseDown:e=>{if(m)return;let a=t.id;p.includes(a)&&y(e=>[a,...e.filter(e=>e!==a)])},onClick:e=>{m||(e.metaKey||e.ctrlKey?y(e=>e.includes(t.id)?e.filter(e=>e!==t.id):[...e,t.id]):y([t.id]))},className:`absolute select-none ${p.includes(t.id)?"ring-2 ring-primary/60":""}`,"data-el":t.id,style:{left:t.x,top:t.y,width:t.w,height:t.h,transform:`rotate(${t.rotation}deg)`,zIndex:t.z},ref:e=>{e?b.current.set(t.id,e):b.current.delete(t.id)},children:(0,r.jsxs)("div",{className:`h-full w-full ${"TEACHER_DESK"===t.type?"rounded-xl":"rounded"} border ${"WINDOW_SIDE"===t.type?"border-sky-700 bg-sky-900/30 border-dashed":"WALL_SIDE"===t.type?"border-neutral-600 bg-neutral-700/60":"border-neutral-700 bg-neutral-800/60"} flex items-center justify-center px-1`,style:{fontSize:(t.meta?.fontSize??20)+"px"},onDoubleClick:a=>{if(m)return;a.stopPropagation();let r="";r="STUDENT"===t.type?t.refId?g.get(String(t.refId))||"":t.meta?.label||"":t.meta?.label||M[t.type],e.setEditing({id:t.id,value:r})},children:[!m&&"STUDENT"===t.type&&(0,r.jsxs)("div",{className:"absolute left-0 top-0 z-10",children:[r.jsx("button",{type:"button",className:"h-7 w-7 flex items-start justify-start text-[14px] leading-none text-neutral-400 hover:text-neutral-200 bg-transparent pl-1 pt-0.5",title:"Sch\xfcler ausw\xe4hlen",onClick:e=>{e.stopPropagation(),S(I===t.id?null:t.id),j("")},children:"▾"}),I===t.id&&(()=>{let e=b.current.get(t.id),a=e?.getBoundingClientRect(),i=(a?.left??0)+window.scrollX,n=(a?.top??0)+window.scrollY+28;return r.jsx(f,{children:(0,r.jsxs)("div",{className:"fixed w-56 rounded border border-neutral-800 bg-neutral-900 shadow-lg p-1 grid gap-1 text-sm max-h-64 overflow-auto",style:{left:i,top:n,zIndex:o.Z.dropdown},onClick:e=>e.stopPropagation(),children:[r.jsx("input",{autoFocus:!0,placeholder:"Suchen…",className:"w-full rounded border border-neutral-800 bg-neutral-950 px-2 py-1 text-xs",value:v,onChange:e=>j(e.target.value)}),r.jsx("button",{className:"w-full text-left rounded px-2 py-1 hover:bg-neutral-800",onClick:()=>{_(e=>e.map(e=>e.id===t.id?{...e,refId:null}:e)),S(null),A()},children:"– Leer –"}),O.filter(e=>e.foreName.toLowerCase().includes(v.toLowerCase())).map(e=>{let a=N.has(String(e.id))&&t.refId!==e.id;return(0,r.jsxs)("button",{disabled:a,className:`w-full text-left rounded px-2 py-1 hover:bg-neutral-800 ${a?"opacity-60 cursor-not-allowed":""}`,onClick:()=>{a||(_(a=>a.map(a=>a.id===t.id?{...a,refId:e.id}:a)),S(null),A())},children:[e.foreName," ",t.refId===e.id&&"✓"," ",a&&"✔"]},e.id)})]})})})()]}),e.editing?.id===t.id?r.jsx("input",{autoFocus:!0,className:"w-full bg-transparent text-center outline-none caret-primary",value:e.editing.value,onClick:e=>e.stopPropagation(),onChange:t=>e.setEditing(e=>({...e,value:t.target.value})),onKeyDown:e.onInlineEditKeyDown?.bind(null,t),onBlur:e.onInlineEditBlur?.bind(null,t)}):r.jsx("span",{className:"truncate w-full text-center",children:"STUDENT"===t.type?t.refId?g.get(String(t.refId))||"Sch\xfcler":t.meta?.label||"leer":t.meta?.label||M[t.type]})]})},t.id)),e.marquee?.active&&r.jsx("div",{className:"absolute border border-primary/60 bg-primary/10 pointer-events-none",style:{left:Math.min(e.marquee.x0,e.marquee.x1),top:Math.min(e.marquee.y0,e.marquee.y1),width:Math.abs(e.marquee.x1-e.marquee.x0),height:Math.abs(e.marquee.y1-e.marquee.y0)}}),!m&&k&&r.jsx(d.ZP,{target:k,draggable:!0,resizable:!0,rotatable:!0,throttleDrag:0,throttleResize:0,throttleRotate:0,snappable:!0,snapThreshold:8,elementGuidelines:Array.from(b.current.entries()).filter(([e])=>!p.includes(e)).map(([e,t])=>t),bounds:{left:0,top:0,right:c.w,bottom:c.h},origin:!1,renderDirections:(()=>{if(w&&("DOOR"===w.type||"WINDOW_SIDE"===w.type||"WALL_SIDE"===w.type))return Math.round((w.rotation%360+360)%360/90)%2==0?["e","w"]:["n","s"]})(),onDrag:e=>{P&&(R(P,e.beforeDelta[0],e.beforeDelta[1]),window.__lastMoveableEvent=e.inputEvent)},onDragStart:t=>{if(e.detachOnDragRef.current=!1,window.__lastMoveableEvent=t.inputEvent,!P)return;let a=new Map(x.map(e=>[e.id,e])),r=[...p.includes(P)?p:[P]],i=new Set;for(;r.length;){let e=r.pop();if(i.has(e))continue;i.add(e);let t=a.get(e);for(let e of Array.isArray(t?.meta?.joints)?t.meta.joints:[])i.has(e.otherId)||r.push(e.otherId)}for(let t of(e.dragStartPositions.current.clear(),i)){let r=a.get(t);r&&e.dragStartPositions.current.set(t,{x:r.x,y:r.y})}},onDragEnd:()=>{P&&L(P,{detach:e.detachOnDragRef.current})},onResizeStart:e=>{e.setKeepRatio?.(e.inputEvent?.shiftKey===!0)},onResize:e.onMoveableResize,onResizeEnd:()=>A(),onRotate:e=>{P&&_(t=>t.map(t=>t.id===P?{...t,rotation:e.beforeRotate}:t))},onRotateEnd:()=>A()}),r.jsx(h,{elements:x,readOnly:m,hoverCandidate:e.jointHover,onCreate:t=>e.createJointFromCandidate?.(t),onDetach:(e,t)=>{D(e,t),A()}})]})})]}),(0,r.jsxs)("aside",{className:`fixed left-0 top-[48px] h-[calc(100vh-48px)] w-72 transform border-r border-neutral-900 bg-bg-soft p-3 overflow-auto transition-transform ${e.sidebarOpen?"translate-x-0":"-translate-x-full"}`,style:{zIndex:o.Z.toolbar},children:[(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3 mb-3 grid gap-2",children:[r.jsx("div",{className:"text-sm font-medium mb-1",children:"Plan"}),t&&(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[r.jsx("span",{className:"text-fg-muted",children:"Ansicht:"}),r.jsx(s.z,{onClick:()=>i("owner"),className:"owner"===a?"bg-primary/20 text-primary":"",children:"Eigen"}),r.jsx(s.z,{onClick:()=>i("lead"),className:"lead"===a?"bg-primary/20 text-primary":"",children:"KL"})]}),(0,r.jsxs)("div",{className:"text-xs text-fg-muted",children:["saving"===n&&r.jsx("span",{children:"Speichern…"}),"saved"===n&&r.jsx("span",{className:"text-primary",children:"Gespeichert"})]})]}),t&&"lead"===a&&(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[r.jsx("div",{className:"text-sm font-medium",children:"KL-Plan"}),r.jsx("div",{className:"text-xs text-fg-muted",children:"Du kannst den Plan der Klassenleitung ansehen. \xc4nderungen sind hier nicht m\xf6glich."}),e.activeProfile&&r.jsx(s.z,{variant:"primary",onClick:async()=>{await fetch("/api/plan/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerProfileId:e.activeProfile.id,classId:W,roomId:U,sourcePlanId:t.id})}),i("owner"),await $(!1)},children:"Als Kopie \xfcbernehmen"})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Palette"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[r.jsx(s.z,{onClick:()=>T("TEACHER_DESK"),children:"Lehrerpult"}),r.jsx(s.z,{onClick:()=>T("DOOR"),children:"T\xfcr"}),r.jsx(s.z,{onClick:()=>T("WINDOW_SIDE"),children:"Fenster"}),r.jsx(s.z,{onClick:()=>T("WALL_SIDE"),children:"Wand"}),r.jsx(s.z,{onClick:E,variant:"primary",children:"Paare-Layout anwenden"})]})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Sch\xfcler hinzuf\xfcgen"}),(0,r.jsxs)("div",{className:"grid gap-2 max-h-[260px] overflow-auto",children:[O.map(e=>(0,r.jsxs)(s.z,{onClick:()=>T("STUDENT",e.id),className:`justify-start ${N.has(String(e.id))?"opacity-60":""}`,disabled:N.has(String(e.id)),children:[r.jsx("span",{className:"flex-1 text-left",children:e.foreName}),N.has(String(e.id))&&r.jsx("span",{className:"text-green-400",children:"✔"})]},e.id)),0===O.length&&r.jsx("div",{className:"text-xs text-fg-muted",children:"Keine Sch\xfcler geladen."})]})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[r.jsx("div",{className:"text-sm font-medium",children:"Auswahl"}),!w&&r.jsx("div",{className:"text-xs text-fg-muted",children:"Nichts ausgew\xe4hlt"}),w&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"text-xs text-fg-muted",children:["Typ: ",w.type]}),(0,r.jsxs)("label",{className:"text-xs text-fg-muted flex items-center gap-2",children:[r.jsx("span",{children:"Schriftgr\xf6\xdfe"}),r.jsx("input",{type:"range",min:8,max:24,value:w.meta?.fontSize??12,onChange:e=>{let t=parseInt(e.target.value,10),a=new Set(p);_(e=>e.map(e=>a.has(e.id)?{...e,meta:{...e.meta||{},fontSize:t}}:e)),A()}}),(0,r.jsxs)("span",{className:"tabular-nums",children:[w.meta?.fontSize??12,"px"]})]}),r.jsx("div",{className:"flex items-center gap-2",children:r.jsx(s.z,{onClick:()=>{let e=new Set(p);_(t=>t.map(t=>{if(!e.has(t.id))return t;let a=(Array.isArray(t.meta?.joints)?t.meta.joints:[]).filter(t=>!e.has(t.otherId));return{...t,meta:{...t.meta||{},joints:a}}})),_(t=>t.map(t=>{let a=(Array.isArray(t.meta?.joints)?t.meta.joints:[]).filter(a=>!e.has(t.id)||!e.has(a.otherId));return{...t,meta:{...t.meta||{},joints:a}}})),A()},children:"Verbindungen der Auswahl l\xf6sen"})}),r.jsx("div",{className:"flex items-center gap-2",children:r.jsx(s.z,{onClick:()=>{let t=w?.meta?.fontSize??20,a=new Set(x.filter(e=>p.includes(e.id)).map(e=>e.type));e.setTypeStyles(e=>{let r={...e};for(let e of a)r[e]={fontSize:t};return r}),_(e=>e.map(e=>a.has(e.type)?{...e,meta:{...e.meta||{},fontSize:t}}:e)),A()},children:"Auf alle Typen in Auswahl anwenden"})}),r.jsx("div",{className:"flex gap-2",children:r.jsx(s.z,{onClick:e.removeSelected,variant:"danger",children:"L\xf6schen"})})]})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[r.jsx("div",{className:"text-sm font-medium",children:"Export"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[r.jsx(s.z,{onClick:z,children:"PNG"}),r.jsx(s.z,{onClick:C,children:"PDF (A4 Quer)"})]})]})]})]})}function m(e="id"){return`${e}_${Math.random().toString(36).slice(2,9)}`}function x(e,t,a,r){return Math.max(0,Math.min(t,r)-Math.max(e,a))}function p(e,t,a=.5){if(!e||!t)return!1;let r=x(e.y,e.y+e.h,t.y,t.y+t.h),i=x(e.x,e.x+e.w,t.x,t.x+t.w);return!!(r>0&&Math.abs(e.x+e.w-t.x)<=a||r>0&&Math.abs(e.x-(t.x+t.w))<=a||i>0&&Math.abs(e.y+e.h-t.y)<=a||i>0&&Math.abs(e.y-(t.y+t.h))<=a)||function(e,t){let a={left:e.x,top:e.y,right:e.x+e.w,bottom:e.y+e.h},r={left:t.x,top:t.y,right:t.x+t.w,bottom:t.y+t.h};return!(a.right<r.left||a.left>r.right||a.bottom<r.top||a.top>r.bottom)}(e,t)}function y({classes:e,rooms:t}){let[n,d]=(0,i.useState)(null),[s,o]=(0,i.useState)(""),[h,u]=(0,i.useState)(""),[f,y]=(0,i.useState)(null),b=(0,i.useRef)(null),[w,g]=(0,i.useState)(null),[M,I]=(0,i.useState)("owner"),[S,v]=(0,i.useState)([]),j=(0,i.useRef)([]),[N,T]=(0,i.useState)([]),[E,D]=(0,i.useState)([]),[A,z]=(0,i.useState)("idle"),[C,k]=(0,i.useState)(!1),P=(0,i.useRef)(new Map),R=(0,i.useRef)(null),[L,_]=(0,i.useState)(null),[O,W]=(0,i.useState)({STUDENT:{fontSize:20},TEACHER_DESK:{fontSize:20},DOOR:{fontSize:20},WINDOW_SIDE:{fontSize:20},WALL_SIDE:{fontSize:20}}),[U,$]=(0,i.useState)({active:!1,x0:0,y0:0,x1:0,y1:0}),[K,B]=(0,i.useState)({id:null,value:""}),[H,q]=(0,i.useState)(null),[J,F]=(0,i.useState)(""),X=(0,i.useRef)(!1),Y=(0,i.useRef)(new Map);(0,i.useRef)(!1);let[G,Z]=(0,i.useState)(null);function V(e,t){v(a=>a.map(a=>{if(a.id===e){let e=(Array.isArray(a.meta?.joints)?a.meta.joints:[]).filter(e=>e.otherId!==t);return{...a,meta:{...a.meta||{},joints:e}}}if(a.id===t){let t=(Array.isArray(a.meta?.joints)?a.meta.joints:[]).filter(t=>t.otherId!==e);return{...a,meta:{...a.meta||{},joints:t}}}return a}))}let Q=(0,i.useCallback)(async e=>{if(!n?.id||!s||!h)return;let t=await fetch(`/api/plan?ownerProfileId=${n.id}&classId=${s}&roomId=${h}&create=${e?"1":"0"}&includeLead=1`);if(!t.ok)return;let a=await t.json();y(a.plan),g(a.leadPlan),v((e=>{let t=new Map,a=new Map;for(let r of e){t.set(r.id,r);let e=Array.isArray(r.meta?.joints)?r.meta.joints:[];a.set(r.id,e.map(e=>({otherId:String(e.otherId),side:e.side,t:Number(e.t)||0,kind:e.kind??void 0,pairId:e.pairId??void 0})))}let r=new Map;for(let t of e)t.groupId&&(r.has(t.groupId)||r.set(t.groupId,[]),r.get(t.groupId).push(t));for(let[,e]of r)for(let t=0;t<e.length;t++)for(let r=t+1;r<e.length;r++){let i=e[t],n=e[r];if(!p(i,n))continue;let d=l({x:i.x,y:i.y,w:i.w,h:i.h},{x:n.x,y:n.y,w:n.w,h:n.h});if(!d)continue;let s=a.get(i.id),o=a.get(n.id);s.some(e=>e.otherId===n.id)||s.push({otherId:n.id,side:d.aSide,t:d.aT,kind:"struct"}),o.some(e=>e.otherId===i.id)||o.push({otherId:i.id,side:d.bSide,t:d.bT,kind:"struct"})}return(()=>{for(let r of e){if("STUDENT"!==r.type)continue;let e=(a.get(r.id)||[]).filter(e=>{let a=t.get(e.otherId);return a?.type==="STUDENT"});if(1!==e.length)continue;let i=e[0],n=t.get(i.otherId),l=(a.get(n.id)||[]).find(e=>e.otherId===r.id);if(!l)continue;let d=i.pairId??l.pairId??m("pair");i.kind="pair",i.pairId=d,l.kind="pair",l.pairId=d}})(),e.map(e=>({...e,groupId:null,meta:{...e.meta||{},joints:a.get(e.id)}}))})(a.plan.elements.map(e=>({...e})))),D([]),setTimeout(()=>ee(),0)},[n?.id,s,h]),ee=(0,i.useCallback)(()=>{b.current&&(R.current&&clearTimeout(R.current),z("saving"),R.current=setTimeout(async()=>{try{if(!(await fetch("/api/plan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:b.current.id,elements:j.current})})).ok)throw Error("save failed");z("saved"),setTimeout(()=>z("idle"),1200)}catch{z("idle")}},900))},[]),et=E[0]??null,ea=(0,i.useMemo)(()=>et?S.find(e=>e.id===et):void 0,[S,et]),er=(0,i.useMemo)(()=>et?P.current.get(et)??null:null,[et,S]),ei=(0,i.useMemo)(()=>{let e=new Map;for(let t of N)e.set(t.id,t.foreName);return e},[N]),en="lead"===M,el=(0,i.useMemo)(()=>{let e=new Set;for(let t of S)"STUDENT"===t.type&&t.refId&&e.add(String(t.refId));return e},[S]),ed=(e,t,a=12)=>{if(en)return null;let r=null,i=S.length;for(let n=0;n<i;n++){let l=S[n];for(let d=n+1;d<i;d++){let i=S[d],n=Math.max(l.y,i.y),s=Math.min(l.y+l.h,i.y+i.h);if(Math.max(0,s-n)>0){let d=l.x+l.w,o=i.x,h=i.x+i.w,u=l.x;if(Math.abs(d-o)<=a){let h=Math.abs(e-(d+o)/2);if(t>=n-a&&t<=s+a&&h<=a){let e=(Math.min(Math.max(t,l.y),l.y+l.h)-l.y)/l.h,a=(Math.min(Math.max(t,i.y),i.y+i.h)-i.y)/i.h,n={aId:l.id,bId:i.id,aSide:"right",bSide:"left",aT:e,bT:a,dist:h};(!r||h<r.dist)&&(r=n)}}if(Math.abs(h-u)<=a){let d=Math.abs(e-(h+u)/2);if(t>=n-a&&t<=s+a&&d<=a){let e=(Math.min(Math.max(t,l.y),l.y+l.h)-l.y)/l.h,a=(Math.min(Math.max(t,i.y),i.y+i.h)-i.y)/i.h,n={aId:l.id,bId:i.id,aSide:"left",bSide:"right",aT:e,bT:a,dist:d};(!r||d<r.dist)&&(r=n)}}}let o=Math.max(l.x,i.x),h=Math.min(l.x+l.w,i.x+i.w);if(Math.max(0,h-o)>0){let n=l.y+l.h,d=i.y,s=i.y+i.h,u=l.y;if(Math.abs(n-d)<=a){let s=Math.abs(t-(n+d)/2);if(e>=o-a&&e<=h+a&&s<=a){let t=(Math.min(Math.max(e,l.x),l.x+l.w)-l.x)/l.w,a=(Math.min(Math.max(e,i.x),i.x+i.w)-i.x)/i.w,n={aId:l.id,bId:i.id,aSide:"bottom",bSide:"top",aT:t,bT:a,dist:s};(!r||s<r.dist)&&(r=n)}}if(Math.abs(s-u)<=a){let n=Math.abs(t-(s+u)/2);if(e>=o-a&&e<=h+a&&n<=a){let t=(Math.min(Math.max(e,l.x),l.x+l.w)-l.x)/l.w,a=(Math.min(Math.max(e,i.x),i.x+i.w)-i.x)/i.w,d={aId:l.id,bId:i.id,aSide:"top",bSide:"bottom",aT:t,bT:a,dist:n};(!r||n<r.dist)&&(r=d)}}}}}return r?{aId:r.aId,bId:r.bId,aSide:r.aSide,bSide:r.bSide,aT:r.aT,bT:r.bT}:null},es=e=>{var t,a,r,i,n,l;t=e.aId,a=e.bId,r=e.aSide,i=e.bSide,n=e.aT,l=e.bT,v(e=>{let d=e.find(e=>e.id===t),s=e.find(e=>e.id===a),o=d?.type==="STUDENT"&&s?.type==="STUDENT"&&("left"===r&&"right"===i||"right"===r&&"left"===i||"top"===r&&"bottom"===i||"bottom"===r&&"top"===i),h=o?"pair":"struct",u=o?m("pair"):void 0;return e.map(e=>{if(e.id===t){let t=Array.isArray(e.meta?.joints)?e.meta.joints:[],i=t.some(e=>e.otherId===a)?t.map(e=>e.otherId===a?{otherId:a,side:r,t:n,kind:e.kind??h,pairId:e.pairId??u}:e):[...t,{otherId:a,side:r,t:n,kind:h,pairId:u}];return{...e,meta:{...e.meta||{},joints:i}}}if(e.id===a){let a=Array.isArray(e.meta?.joints)?e.meta.joints:[],r=a.some(e=>e.otherId===t)?a.map(e=>e.otherId===t?{otherId:t,side:i,t:l,kind:e.kind??h,pairId:e.pairId??u}:e):[...a,{otherId:t,side:i,t:l,kind:h,pairId:u}];return{...e,meta:{...e.meta||{},joints:r}}}return e})}),Z(null),ee()},[eo,eh]=(0,i.useState)({w:1200,h:700}),eu=(0,i.useRef)(null),ef=(0,i.useRef)(null);async function ec(){if(!ef.current)return;let{toPng:e}=await a.e(546).then(a.bind(a,7546)),t=await e(ef.current,{cacheBust:!0,pixelRatio:2}),r=document.createElement("a");r.href=t,r.download=`sitzplan-${s}-${h}.png`,r.click()}async function em(){if(!ef.current)return;let[{toPng:e},{jsPDF:t}]=await Promise.all([a.e(546).then(a.bind(a,7546)),a.e(296).then(a.bind(a,7296))]),r=await e(ef.current,{cacheBust:!0,pixelRatio:2}),i=new t({orientation:"landscape",unit:"pt",format:"a4"}),n=i.internal.pageSize.getWidth(),l=i.internal.pageSize.getHeight(),d=new Image;d.src=r,await new Promise(e=>{d.onload=e});let o=Math.min(n/d.width,l/d.height),u=d.width*o,f=d.height*o;i.addImage(r,"PNG",(n-u)/2,(l-f)/2,u,f),i.save(`sitzplan-${s}-${h}.pdf`)}return r.jsx(c,{ctx:{leadPlan:w,viewMode:M,setViewMode:I,saving:A,frameRef:eu,canvasRef:ef,frameSize:eo,readOnly:en,elements:S,selectedIds:E,setSelectedIds:D,elementRefs:P,selected:ea,studentById:ei,defaultTerms:{TEACHER_DESK:"Lehrerpult",DOOR:"T\xfcr",WINDOW_SIDE:"Fenster",WALL_SIDE:"Wand"},pickerOpenId:H,setPickerOpenId:q,pickerQuery:J,setPickerQuery:F,usedStudentIds:el,addElement:(e,t,a)=>{if(en)return;let r=O[e]?.fontSize??20,i={id:m("el"),type:e,refId:t??null,x:a?.x??(C?320:120),y:a?.y??120,w:120,h:70,rotation:0,z:S.length,groupId:null,meta:{fontSize:r}};if("WINDOW_SIDE"===e||"WALL_SIDE"===e){i.h=Math.max(24,r+8);let t=S.filter(e=>"STUDENT"===e.type),a=t.length?Math.min(...t.map(e=>e.x)):null,n=t.length?Math.max(...t.map(e=>e.x+e.w)):null,l=t.length?Math.min(...t.map(e=>e.y)):null,d=t.length?Math.max(...t.map(e=>e.y+e.h)):null;i.w=Math.min(Math.max(160,null!==l&&null!==d?Math.max(160,d-l+24):320),Math.max(160,eo.h-24)),i.rotation=90;let s=i.h,o=null!==l&&null!==d?(l+d)/2:eo.h/2;if("WINDOW_SIDE"===e){let e=eo.w-12-s/2;i.x=Math.max(0,Math.min(e,null!==n?n+12+s/2:e)-i.w/2),i.y=Math.max(0,Math.min(eo.h-i.h,o-i.h/2))}else{let e=12+s/2;i.x=Math.max(0,Math.min(eo.w-i.w,Math.max(e,null!==a?a-12-s/2:e)-i.w/2)),i.y=Math.max(0,Math.min(eo.h-i.h,o-i.h/2))}}"DOOR"===e&&(i.w=48,i.h=10),"TEACHER_DESK"===e&&(i.w=260,i.h=80),v(e=>[...e,i]),ee()},applyPairsLayout:()=>{if(en)return;let e=S.filter(e=>"STUDENT"===e.type),t=N.length,a=Math.max(t,e.length);if(0===a)return;let r=Math.max(1,Math.floor((Math.max(0,eo.w-80)+24)/264)),i=Math.ceil(a/2),n=Math.ceil(i/r),l=[],d=0;for(let e=0;e<n;e++){let t=40,a=60+94*e;for(let e=0;e<r&&!(d>=i);e++){let e={id:m("el"),type:"STUDENT",refId:null,x:t,y:a,w:120,h:70,rotation:0,z:l.length,groupId:null,meta:{fontSize:O.STUDENT.fontSize}},r={id:m("el"),type:"STUDENT",refId:null,x:t+120,y:a,w:120,h:70,rotation:0,z:l.length+1,groupId:null,meta:{fontSize:O.STUDENT.fontSize}},i=(e,t)=>Array.isArray(e)?[...e,t]:[t],n=m("pair");e.meta={...e.meta||{},joints:i(e.meta?.joints,{otherId:r.id,side:"right",t:.5,kind:"pair",pairId:n})},r.meta={...r.meta||{},joints:i(r.meta?.joints,{otherId:e.id,side:"left",t:.5,kind:"pair",pairId:n})},l.push(e,r),d++,t+=264}}let s=l.map((a,r)=>r<t?{...a,refId:N[r].id}:r<e.length?{...a,refId:e[r].refId??null}:a);v(e=>[...e.filter(e=>"STUDENT"!==e.type),...s]),ee()},removeJoint:V,scheduleSave:ee,exportPng:ec,exportPdf:em,selectedTarget:er,primarySelectedId:et,moveElementBy:(e,t,a)=>{en||v(r=>{if(!r.find(t=>t.id===e))return r;let i=new Map(r.map(e=>[e.id,e])),n=[...E.includes(e)?E.slice():[e]],l=new Set;for(;n.length;){let e=n.pop();if(l.has(e))continue;l.add(e);let t=i.get(e);for(let e of Array.isArray(t?.meta?.joints)?t.meta.joints:[])l.has(e.otherId)||n.push(e.otherId)}return r.map(e=>l.has(e.id)?{...e,x:e.x+t,y:e.y+a}:e)})},onDragEnd:(e,t)=>{if(en)return;let a=S.find(t=>t.id===e),r=e=>{let t=new Map(S.map(e=>[e.id,e])),a=[...e],r=new Set;for(;a.length;){let e=a.pop();if(r.has(e))continue;r.add(e);let i=t.get(e);for(let e of Array.isArray(i?.meta?.joints)?i.meta.joints:[])r.has(e.otherId)||a.push(e.otherId)}return Array.from(r)};if((()=>{a?.x,a?.y,a&&(a.x,a.w,a.y,a.h);try{let e=window.__lastMoveableEvent||null;if(e?.clientX&&ef.current){let t=ef.current.getBoundingClientRect();e.clientX,t.left,e.clientY,t.top}}catch{}})(),a&&("WINDOW_SIDE"===a.type||"WALL_SIDE"===a.type)){let e=S.filter(e=>e.id!==a.id&&("WINDOW_SIDE"===e.type||"WALL_SIDE"===e.type)&&e.type!==a.type),t=null,r=0,i=a.w*a.h;for(let n of e){let e=Math.max(a.x,n.x),l=Math.min(a.x+a.w,n.x+n.w),d=Math.max(a.y,n.y),s=Math.max(0,l-e)*Math.max(0,Math.min(a.y+a.h,n.y+n.h)-d),o=i>0&&n.w*n.h>0?s/Math.min(i,n.w*n.h):0;o>=.5&&o>r&&(r=o,t=n)}if(t){v(e=>e.map(e=>e.id===a.id?{...e,x:t.x,y:t.y,w:t.w,h:t.h,rotation:t.rotation,z:t.z}:e.id===t.id?{...e,x:a.x,y:a.y,w:a.w,h:a.h,rotation:a.rotation,z:a.z}:e)),ee();return}}if(a&&("WINDOW_SIDE"===a.type||"WALL_SIDE"===a.type)){ee();return}if(a&&"STUDENT"===a.type){let e=e=>{let t=(Array.isArray(e.meta?.joints)?e.meta.joints:[]).find(e=>"pair"===e.kind&&"string"==typeof e.otherId);if(t){let e=S.find(e=>e.id===t.otherId)||null;if(e&&"STUDENT"===e.type)return{partner:e,side:t.side,pairId:t.pairId}}let a=null;for(let t of S){if(t.id===e.id||"STUDENT"!==t.type)continue;let r=l({x:e.x,y:e.y,w:e.w,h:e.h},{x:t.x,y:t.y,w:t.w,h:t.h});if(!r)continue;let i=Math.max(Math.max(0,Math.min(e.y+e.h,t.y+t.h)-Math.max(e.y,t.y)),Math.max(0,Math.min(e.x+e.w,t.x+t.w)-Math.max(e.x,t.x)));(!a||i>a.score)&&(a={partner:t,side:r.aSide,score:i})}return a?{partner:a.partner,side:a.side}:null},t=e(a),i=t?.partner??null,n=i?[a.id,i.id]:[a.id],d=r([a.id]),s=S.filter(e=>d.includes(e.id)&&"STUDENT"===e.type).map(e=>e.id),o=S.filter(e=>"STUDENT"===e.type&&!d.includes(e.id)),h=null,u=0,f=a.w*a.h;for(let e of o){let t=Math.max(a.x,e.x),r=Math.min(a.x+a.w,e.x+e.w),i=Math.max(a.y,e.y),n=Math.max(0,r-t)*Math.max(0,Math.min(a.y+a.h,e.y+e.h)-i),l=f>0&&e.w*e.h>0?n/Math.min(f,e.w*e.h):0;l>=.5&&l>u&&(u=l,h=e)}if(h){let t=r([h.id]),i=S.filter(e=>t.includes(e.id)&&"STUDENT"===e.type).map(e=>e.id);if(s.length>1&&s.length===i.length&&((e,t)=>{let a=e=>e.map(e=>S.find(t=>t.id===e)).filter(Boolean).sort((e,t)=>e.y-t.y||e.x-t.x).map(e=>e.id),r=a(e),i=a(t);if(r.length!==i.length)return!1;let n=Y.current;return v(e=>{let t=new Map(e.map(e=>[e.id,e.refId??null]));return e.map(e=>{let a=e,l=r.indexOf(e.id),d=i.indexOf(e.id);return l>=0?a={...a,refId:t.get(i[l])??null}:d>=0&&(a={...a,refId:t.get(r[d])??null}),n.size>0&&n.has(e.id)&&(a={...a,x:n.get(e.id).x,y:n.get(e.id).y}),a})}),!0})(s,i)){ee();return}if(s.length!==i.length){let e=S.filter(e=>s.includes(e.id)),t=S.filter(e=>i.includes(e.id)),a=e=>e.w*e.h,r=[];for(let i of e)for(let e of t){let t=Math.max(i.x,e.x),n=Math.min(i.x+i.w,e.x+e.w),l=Math.max(i.y,e.y),d=Math.max(0,n-t)*Math.max(0,Math.min(i.y+i.h,e.y+e.h)-l),s=Math.min(a(i),a(e)),o=s>0?d/s:0;o>=.5&&r.push({aId:i.id,bId:e.id,ratio:o})}r.sort((e,t)=>t.ratio-e.ratio);let n=new Set,l=new Set,d=[];for(let e of r)n.has(e.aId)||l.has(e.bId)||(n.add(e.aId),l.add(e.bId),d.push({aId:e.aId,bId:e.bId}));if(d.length>0){(e=>{let t=Y.current;v(a=>{let r=new Map(a.map(e=>[e.id,e.refId??null])),i=new Map(e.map(e=>[e.aId,e.bId])),n=new Map(e.map(e=>[e.bId,e.aId]));return a.map(e=>{let a=e;return i.has(e.id)?a={...a,refId:r.get(i.get(e.id))??null}:n.has(e.id)&&(a={...a,refId:r.get(n.get(e.id))??null}),t.size>0&&t.has(e.id)&&(a={...a,x:t.get(e.id).x,y:t.get(e.id).y}),a})})})(d),ee();return}}let l=e(h),d=l?.partner??null,o=2===n.length,u=!!d&&S.find(e=>e.id===d.id)?.type==="STUDENT";o&&u?((e,t)=>{let a=e=>{let t=S.find(t=>t.id===e),a=(Array.isArray(t.meta?.joints)?t.meta.joints:[]).find(e=>"pair"===e.kind),r=a?.side||"left";return"left"===r||"top"===r?0:1},r=[...e].sort((e,t)=>a(e)-a(t)),i=[...t].sort((e,t)=>a(e)-a(t)),n=Y.current;v(e=>{let t=new Map(e.map(e=>[e.id,e.refId??null]));return e.map(e=>{let a=e;return e.id===r[0]?a={...a,refId:t.get(i[0])??null}:e.id===r[1]?a={...a,refId:t.get(i[1])??null}:e.id===i[0]?a={...a,refId:t.get(r[0])??null}:e.id===i[1]&&(a={...a,refId:t.get(r[1])??null}),n.size>0&&n.has(e.id)&&(a={...a,x:n.get(e.id).x,y:n.get(e.id).y}),a})})})(n,[h.id,d.id]):((e,t)=>{let a=Y.current;v(r=>{let i=new Map(r.map(e=>[e.id,e.refId??null]));return r.map(r=>{let n=r;return r.id===e?n={...n,refId:i.get(t)??null}:r.id===t&&(n={...n,refId:i.get(e)??null}),a.size>0&&a.has(r.id)&&(n={...n,x:a.get(r.id).x,y:a.get(r.id).y}),n})})})(a.id,h.id),ee();return}}v(a=>{let r=a.find(t=>t.id===e);if(!r)return a;if(t?.detach)return setTimeout(()=>{for(let t of a)t.id!==e&&V(e,t.id);ee()},0),a;let i=function(e,t,a=8){let r=null;for(let i of t){if(x(e.y,e.y+e.h,i.y,i.y+i.h)>0){let t=i.x-e.x;Math.abs(t)<=a&&(r=!r||Math.abs(t)<Math.hypot(r.dx,r.dy)?{dx:t,dy:0}:r);let n=i.x+i.w-(e.x+e.w);Math.abs(n)<=a&&(r=!r||Math.abs(n)<Math.hypot(r.dx,r.dy)?{dx:n,dy:0}:r);let l=i.x-(e.x+e.w);Math.abs(l)<=a&&(r=!r||Math.abs(l)<Math.hypot(r.dx,r.dy)?{dx:l,dy:0}:r);let d=i.x+i.w-e.x;Math.abs(d)<=a&&(r=!r||Math.abs(d)<Math.hypot(r.dx,r.dy)?{dx:d,dy:0}:r)}if(x(e.x,e.x+e.w,i.x,i.x+i.w)>0){let t=i.y-e.y;Math.abs(t)<=a&&(r=!r||Math.abs(t)<Math.hypot(r.dx,r.dy)?{dx:0,dy:t}:r);let n=i.y+i.h-(e.y+e.h);Math.abs(n)<=a&&(r=!r||Math.abs(n)<Math.hypot(r.dx,r.dy)?{dx:0,dy:n}:r);let l=i.y-(e.y+e.h);Math.abs(l)<=a&&(r=!r||Math.abs(l)<Math.hypot(r.dx,r.dy)?{dx:0,dy:l}:r);let d=i.y+i.h-e.y;Math.abs(d)<=a&&(r=!r||Math.abs(d)<Math.hypot(r.dx,r.dy)?{dx:0,dy:d}:r)}}return r}(r,a.filter(t=>t.id!==e),8),n=r;i&&(n={...r,x:r.x+i.dx,y:r.y+i.dy});let d=new Map(a.map(e=>[e.id,e])),s=[e],o=new Set;for(;s.length;){let e=s.pop();if(o.has(e))continue;o.add(e);let t=d.get(e);for(let e of Array.isArray(t?.meta?.joints)?t.meta.joints:[])!o.has(e.otherId)&&d.has(e.otherId)&&s.push(e.otherId)}let h=Array.from(o),u=new Map;for(let t of h){let r=t===e?n:d.get(t);if(!r)continue;let i=null,s=-1/0;for(let e of a){if(o.has(e.id)||!p(r,e)||!l({x:r.x,y:r.y,w:r.w,h:r.h},{x:e.x,y:e.y,w:e.w,h:e.h}))continue;let t=Math.max(Math.max(0,Math.min(r.y+r.h,e.y+e.h)-Math.max(r.y,e.y)),Math.max(0,Math.min(r.x+r.w,e.x+e.w)-Math.max(r.x,e.x)));t>s&&(s=t,i=e)}if(i){let e=l({x:r.x,y:r.y,w:r.w,h:r.h},{x:i.x,y:i.y,w:i.w,h:i.h});if(e){let a=i,n=r.x,l=r.y;"right"===e.aSide&&"left"===e.bSide?(n=a.x-r.w,l=a.y+e.bT*a.h-e.aT*r.h):"left"===e.aSide&&"right"===e.bSide?(n=a.x+a.w,l=a.y+e.bT*a.h-e.aT*r.h):"bottom"===e.aSide&&"top"===e.bSide?(l=a.y-r.h,n=a.x+e.bT*a.w-e.aT*r.w):"top"===e.aSide&&"bottom"===e.bSide&&(l=a.y+a.h,n=a.x+e.bT*a.w-e.aT*r.w),u.set(t,{x:n,y:l})}}}return a.map(t=>{if(t.id===e){let t=u.get(e);return t?{...n,x:t.x,y:t.y}:{...n}}if(u.has(t.id)){let e=u.get(t.id);return{...t,x:e.x,y:e.y}}return t})}),ee()},setElements:v,students:N,classId:s,roomId:h,loadPlan:Q,setMarquee:$,marquee:U,editing:K,setEditing:B,detachOnDragRef:X,dragStartPositions:Y,sidebarOpen:C,activeProfile:n,setTypeStyles:W,removeSelected:()=>{if(en||0===E.length)return;let e=new Set(E);v(t=>t.filter(t=>!e.has(t.id)).map(t=>{let a=Array.isArray(t.meta?.joints)?t.meta.joints:[],r=a.filter(t=>!e.has(t.otherId));return r.length!==a.length?{...t,meta:{...t.meta||{},joints:r}}:t})),D([]),ee()},setStudents:T,tryCreateJointAt:(e,t)=>{let a=ed(e,t);return!!a&&(es(a),!0)},updateJointHover:(e,t)=>{let a=ed(e,t);return Z(a),!!a},jointHover:G,setJointHover:Z,createJointFromCandidate:es,onInlineEditKeyDown:async(e,t)=>{if("Escape"===t.key){B({id:null,value:""});return}if("Enter"===t.key){let t=K.value.trim();if(!t){B({id:null,value:""});return}if("STUDENT"===e.type&&e.refId)try{await fetch(`/api/students/${e.refId}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({foreName:t})}),T(a=>a.map(a=>a.id===e.refId?{...a,foreName:t}:a))}catch{}else v(a=>a.map(a=>a.id===e.id?{...a,meta:{...a.meta||{},label:t}}:a)),ee();B({id:null,value:""})}},onInlineEditBlur:async e=>{let t=K.value.trim();if(B({id:null,value:""}),t){if("STUDENT"===e.type&&e.refId)try{await fetch(`/api/students/${e.refId}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({foreName:t})}),T(a=>a.map(a=>a.id===e.refId?{...a,foreName:t}:a))}catch{}else v(a=>a.map(a=>a.id===e.id?{...a,meta:{...a.meta||{},label:t}}:a)),ee()}},onMoveableResize:e=>{if(!et)return;let{width:t,height:a,drag:r,direction:i}=e;v(e=>e.map(e=>{if(e.id!==et)return e;let n=Math.max(10,t),l=Math.max(10,a);("DOOR"===e.type||"WINDOW_SIDE"===e.type||"WALL_SIDE"===e.type)&&(Math.round((e.rotation%360+360)%360/90)%2==0?l=e.h:n=e.w);let d=e.x+(r?.beforeTranslate?.[0]??0),s=e.y+(r?.beforeTranslate?.[1]??0),o=n-e.w,h=l-e.h,u=Array.isArray(i)?i[0]:0,f=Array.isArray(i)?i[1]:0;if((0!==o||0!==h)&&Array.isArray(e.meta?.joints)){let t=e.meta.joints;setTimeout(()=>{v(e=>e.map(e=>{let a=t.find(t=>t.otherId===e.id);return a?1===u&&"right"===a.side?{...e,x:e.x+o}:-1===u&&"left"===a.side?{...e,x:e.x-o}:1===f&&"bottom"===a.side?{...e,y:e.y+h}:-1===f&&"top"===a.side?{...e,y:e.y-h}:e:e}))},0)}return{...e,w:n,h:l,x:d,y:s}}))}}})}},8095:(e,t,a)=>{"use strict";a.d(t,{M:()=>d});var r=a(8570);let i=(0,r.createProxy)(String.raw`/Users/jz/Platzhirsch/components/editor/Editor.tsx`),{__esModule:n,$$typeof:l}=i;i.default;let d=(0,r.createProxy)(String.raw`/Users/jz/Platzhirsch/components/editor/Editor.tsx#Editor`)},1803:(e,t,a)=>{"use strict";a.r(t),a.d(t,{createClass:()=>s,deleteClass:()=>h,listClasses:()=>d,setClassLead:()=>o});var r=a(4330);a(166);var i=a(71),n=a(883),l=a(7708);async function d(){let e=(0,n.I)();if(!(0,n.u)(e,"read","class"))throw Error("forbidden");try{return await i._.class.findMany({orderBy:{name:"asc"},include:{leadProfile:!0}})}catch(e){return console.warn("listClasses fallback due to DB error:",e),[]}}async function s(e,t){let a=(0,n.I)();if(!(0,n.u)(a,"create","class"))throw Error("forbidden");let r=await i._.class.create({data:{name:e,leadProfileId:t||null}});return(0,l.revalidatePath)("/classes"),r}async function o(e,t){let a=(0,n.I)();if(!(0,n.u)(a,"update","class"))throw Error("forbidden");await i._.class.update({where:{id:e},data:{leadProfileId:t}}),(0,l.revalidatePath)("/classes")}async function h(e){let t=(0,n.I)();if(!(0,n.u)(t,"delete","class"))throw Error("forbidden");await i._.class.delete({where:{id:e}}),(0,l.revalidatePath)("/classes")}(0,a(618).h)([d,s,o,h]),(0,r.j)("b1a86aeaa537ef061ece06ae838f0f0fbfb3aa3d",d),(0,r.j)("4c018bc9b36e8e4ee0c64573afa34673fa514a06",s),(0,r.j)("7914dc5fbc064000e9e7e67beeae2d6d76de8861",o),(0,r.j)("1aad7720052bcbb3c3fff8073038f2a189fc9f98",h)},1379:(e,t,a)=>{"use strict";a.r(t),a.d(t,{createRoom:()=>o,deleteRoom:()=>h,listRooms:()=>s});var r=a(4330);a(166);var i=a(71),n=a(883),l=a(7708),d=a(3524);async function s(){let e=(0,n.I)();if(!(0,n.u)(e,"read","room"))throw Error("forbidden");try{return await i._.room.findMany({orderBy:{name:"asc"}})}catch(e){return console.warn("listRooms fallback due to DB error:",e),[]}}async function o(e,t="normal"){let a=(0,n.I)();if(!(0,n.u)(a,"create","room"))throw Error("forbidden");let r=await i._.room.create({data:{name:e,type:"adHoc"===t?d.RoomType.ADHOC:d.RoomType.NORMAL}});return(0,l.revalidatePath)("/rooms"),r}async function h(e){let t=(0,n.I)();if(!(0,n.u)(t,"delete","room"))throw Error("forbidden");await i._.room.delete({where:{id:e}}),(0,l.revalidatePath)("/rooms")}(0,a(618).h)([s,o,h]),(0,r.j)("8a57dfb094cf75dda1cd39da095655f2cc8d362e",s),(0,r.j)("51a097bff94b6d7bde5cfb7a76cc419ca2d2d897",o),(0,r.j)("88a28fa01bf8eb3ed6954f8a4f4ae43143c0f7e0",h)},71:(e,t,a)=>{"use strict";a.d(t,{_:()=>i});var r=a(3524);let i=globalThis.prisma??new r.PrismaClient({log:["error"]})},883:(e,t,a)=>{"use strict";function r(){return{id:"anonymous",role:"anonymous"}}function i(e,t,a){return!0}a.d(t,{I:()=>r,u:()=>i})}};