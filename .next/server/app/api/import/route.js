"use strict";(()=>{var e={};e.id=427,e.ids=[427],e.modules={3524:e=>{e.exports=require("@prisma/client")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9661:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>x,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{POST:()=>p});var n=a(9303),s=a(8716),i=a(670),o=a(7070),l=a(7708),d=a(883),u=a(71);async function m(e){let t=[],a=0,r=0,n=0,s=e.map((e,t)=>({index:t,foreName:String(e.foreName||"").trim(),className:String(e.className||"").trim(),externalKey:String(e.externalKey||"").trim()}));for(let e of s)e.foreName&&e.className&&e.externalKey||t.push({index:e.index,message:"Fehlende Werte (foreName, klasse.name, externKey)"});let i=s.filter(e=>e.foreName&&e.className&&e.externalKey),o={},l=[];for(let e of i){if(void 0!==o[e.externalKey]){t.push({index:e.index,message:`Duplikat in Datei: externKey bereits in Zeile ${o[e.externalKey]+1}`});continue}o[e.externalKey]=e.index,l.push(e)}if(0===l.length)return{createdStudents:a,updatedStudents:r,createdClasses:n,errors:t};let d=Array.from(new Set(l.map(e=>e.className))),m=new Map((await u._.class.findMany({where:{name:{in:d}},select:{id:!0,name:!0}})).map(e=>[e.name,e.id])),p=d.filter(e=>!m.has(e));p.length>0&&(await u._.class.createMany({data:p.map(e=>({name:e}))}),n+=p.length);let c=new Map((await u._.class.findMany({where:{name:{in:d}},select:{id:!0,name:!0}})).map(e=>[e.name,e.id])),x=l.map(e=>e.externalKey),f=new Map((await u._.student.findMany({where:{externalKey:{in:x}},select:{id:!0,externalKey:!0}})).map(e=>[e.externalKey,e.id])),h=[],g=[];for(let e of l){let a=c.get(e.className);if(!a){t.push({index:e.index,message:`Klasse nicht gefunden oder erzeugt: ${e.className}`});continue}let r=f.get(e.externalKey);r?g.push({id:r,foreName:e.foreName,classId:a,index:e.index}):h.push({externalKey:e.externalKey,foreName:e.foreName,classId:a})}if(h.length>0){for(let e=0;e<h.length;e+=1e3){let t=h.slice(e,e+1e3);await u._.student.createMany({data:t})}a+=h.length}if(g.length>0){let e=g.map(e=>u._.student.update({where:{id:e.id},data:{foreName:e.foreName,classId:e.classId,active:!0}}));await u._.$transaction(e),r+=g.length}return{createdStudents:a,updatedStudents:r,createdClasses:n,errors:t}}async function p(e){try{let t=(0,d.I)();if(!(0,d.u)(t,"create","student"))return o.NextResponse.json({error:"forbidden"},{status:403});let a=await e.json(),r=a?.rows??[],n=await m(r);return(0,l.revalidatePath)("/students"),(0,l.revalidatePath)("/classes"),o.NextResponse.json(n)}catch(e){return o.NextResponse.json({error:e?.message??"unknown error"},{status:500})}}let c=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/import/route",pathname:"/api/import",filename:"route",bundlePath:"app/api/import/route"},resolvedPagePath:"/Users/jz/Platzhirsch/app/api/import/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:f,serverHooks:h}=c,g="/api/import/route";function y(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},71:(e,t,a)=>{a.d(t,{_:()=>n});var r=a(3524);let n=globalThis.prisma??new r.PrismaClient({log:["error"]})},883:(e,t,a)=>{function r(){return{id:"anonymous",role:"anonymous"}}function n(e,t,a){return!0}a.d(t,{I:()=>r,u:()=>n})}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[948,59,708],()=>a(9661));module.exports=r})();