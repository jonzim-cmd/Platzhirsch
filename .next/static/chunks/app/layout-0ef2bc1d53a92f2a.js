(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{67:function(){},2061:function(){},3717:function(e,t,a){Promise.resolve().then(a.t.bind(a,8877,23)),Promise.resolve().then(a.bind(a,7770))},7770:function(e,t,a){"use strict";a.d(t,{TopBar:function(){return h}});var r=a(7437),n=a(2265),l=a(4308);let s=n.forwardRef((e,t)=>{let{label:a,className:n="",...l}=e;return(0,r.jsxs)("label",{className:"grid gap-2 text-sm",children:[a?(0,r.jsx)("span",{className:"text-fg-muted",children:a}):null,(0,r.jsx)("input",{ref:t,className:"rounded border border-neutral-800 bg-neutral-900 px-3 py-2 outline-none ring-0 focus:border-neutral-600 "+n,...l})]})});s.displayName="Input";var i=a(8334),d=a(4887);function o(e){let{children:t,onClose:a}=e;(0,n.useEffect)(()=>{let e=document.body.style.overflow;document.body.style.overflow="hidden";let t=e=>{"Escape"===e.key&&a()};return window.addEventListener("keydown",t),()=>{document.body.style.overflow=e,window.removeEventListener("keydown",t)}},[a]);let l=(0,r.jsxs)("div",{"aria-modal":"true",role:"dialog",className:"fixed inset-0",style:{zIndex:i.Z.modal},children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/60",onClick:a}),(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center p-4 overflow-auto",children:t})]});return"undefined"==typeof document?null:(0,d.createPortal)(l,document.body)}var c=a(3195);function u(e){let{createMode:t,profile:a,onClose:i}=e,[d,u]=(0,n.useState)((null==a?void 0:a.name)||""),[h,m]=(0,n.useState)([]),[f,p]=(0,n.useState)(!1),[x,g]=(0,n.useState)(!1),[v,y]=(0,n.useState)(!1);function b(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{timeoutMs:a=1e4,...r}=t,n=new AbortController,l=setTimeout(()=>n.abort(),a);return fetch(e,{...r,signal:n.signal}).finally(()=>clearTimeout(l))}async function j(e){let t=await e.text();if(t)try{return JSON.parse(t)}catch(e){throw Error("Ung\xfcltige Server-Antwort")}}async function w(){p(!0);try{let e=(null==a?void 0:a.id)||"";for(let r of(t?e=(await fetch("/api/profiles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:d})}).then(e=>e.json())).id:d!==(null==a?void 0:a.name)&&await fetch("/api/profiles/".concat(null==a?void 0:a.id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:d})}),h)){let t=!!r.assigned;await fetch("/api/profile-classes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({profileId:e,classId:r.id,assigned:t})})}for(let t of h){let a=t.leadProfileId===e;await fetch("/api/class/lead",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({classId:t.id,leadProfileId:a?e:null})})}y(!0),i(!0)}finally{p(!1)}}return(0,n.useEffect)(()=>{let e=null==a?void 0:a.id;!t&&e?b("/api/profile-classes?profileId=".concat(e)).then(async e=>{if(!e.ok)throw Error(await e.text()||"Fehler beim Laden der Klassen");let t=await j(e);return Array.isArray(t)?t:[]}).then(m).catch(async()=>{m((await b("/api/classes").then(async e=>{if(!e.ok)return[];let t=await j(e);return Array.isArray(t)?t:[]})).map(e=>{var t;return{id:e.id,name:e.name,assigned:!1,leadProfileId:null!==(t=e.leadProfileId)&&void 0!==t?t:null}}))}):b("/api/profile-classes?profileId=__none__").then(async e=>{if(!e.ok)throw Error("failed");let t=await j(e);Array.isArray(t)&&m(t.map(e=>{var t;return{...e,assigned:!1,leadProfileId:null!==(t=e.leadProfileId)&&void 0!==t?t:null}}))}).catch(async()=>{m((await b("/api/classes").then(async e=>{if(!e.ok)return[];let t=await j(e);return Array.isArray(t)?t:[]})).map(e=>{var t;return{id:e.id,name:e.name,assigned:!1,leadProfileId:null!==(t=e.leadProfileId)&&void 0!==t?t:null}}))})},[null==a?void 0:a.id,t]),(0,r.jsx)(o,{onClose:()=>i(!1),children:(0,r.jsxs)("div",{className:"w-[min(90vw,800px)] max-h-[85vh] overflow-auto rounded border border-neutral-800 bg-bg-soft p-4 shadow-xl",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("div",{className:"text-lg font-medium",children:t?"Profil anlegen":"Profil bearbeiten"}),(0,r.jsx)("button",{className:"text-fg-muted hover:text-fg",onClick:()=>i(!!v),children:"✕"})]}),(0,r.jsxs)("div",{className:"mt-4 grid gap-4",children:[(0,r.jsx)(s,{label:"Name",value:d,onChange:e=>u(e.target.value),placeholder:"z. B. Frau M\xfcller"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"mb-2 text-sm font-medium",children:"Klassen (Zuweisung + Klassenleitung)"}),(0,r.jsx)("div",{className:"max-h-[40vh] overflow-auto rounded border border-neutral-900",children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{className:"bg-neutral-900/50",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-3 py-2 text-left",children:"Zugewiesen"}),(0,r.jsx)("th",{className:"px-3 py-2 text-left",children:"Klasse"}),(0,r.jsx)("th",{className:"px-3 py-2 text-left",children:"KL"})]})}),(0,r.jsxs)("tbody",{children:[h.map(e=>(0,r.jsxs)("tr",{className:"border-t border-neutral-900",children:[(0,r.jsx)("td",{className:"px-3 py-2",children:(0,r.jsx)("input",{type:"checkbox",checked:e.assigned,onChange:()=>{var t;return t=e.id,void(m(e=>e.map(e=>e.id===t?{...e,assigned:!e.assigned}:e)),y(!0))}})}),(0,r.jsx)("td",{className:"px-3 py-2",children:e.name}),(0,r.jsx)("td",{className:"px-3 py-2",children:(0,r.jsx)("input",{type:"checkbox",checked:!!e.leadProfileId&&(!(null==a?void 0:a.id)||e.leadProfileId===(null==a?void 0:a.id)),onChange:()=>{var t;return t=e.id,void(m(e=>e.map(e=>e.id===t?{...e,leadProfileId:e.leadProfileId?null:(null==a?void 0:a.id)||"__temp__"}:e)),y(!0))}})})]},e.id)),0===h.length&&(0,r.jsx)("tr",{children:(0,r.jsx)("td",{className:"px-3 py-6 text-xs text-fg-muted",colSpan:3,children:"Keine Klassen gefunden."})})]})]})})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("div",{className:"text-sm font-medium",children:"Sch\xfcler importieren (XLSX/CSV)"}),(0,r.jsx)(l.z,{onClick:()=>g(e=>!e),children:x?"Schlie\xdfen":"\xd6ffnen"})]}),x&&(0,r.jsx)("div",{className:"mt-2",children:(0,r.jsx)(c.ImportStudents,{})})]}),(0,r.jsxs)("div",{className:"flex justify-between gap-2",children:[!t&&(null==a?void 0:a.id)&&(0,r.jsx)(l.z,{variant:"danger",onClick:async()=>{confirm("Profil und zugeh\xf6rige Pl\xe4ne wirklich l\xf6schen?")&&(await fetch("/api/profiles/".concat(a.id),{method:"DELETE"}),i(!0))},children:"Profil l\xf6schen"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)(l.z,{onClick:()=>i(!!v),children:"Abbrechen"}),(0,r.jsx)(l.z,{variant:"primary",onClick:w,disabled:f||!d.trim(),children:t?"Anlegen":"Speichern"})]})]})]})]})})}function h(){let[e,t]=(0,n.useState)([]),[a,s]=(0,n.useState)([]),[i,d]=(0,n.useState)([]),[o,c]=(0,n.useState)(null),[h,m]=(0,n.useState)(""),[f,p]=(0,n.useState)(""),[x,g]=(0,n.useState)(!1),[v,y]=(0,n.useState)(!1),[b,j]=(0,n.useState)(!1);function w(e,t,a){let r=new URL(window.location.href);r.searchParams.delete("p"),r.searchParams.delete("c"),r.searchParams.delete("r"),e&&r.searchParams.set("p",e),t&&r.searchParams.set("c",t),a&&r.searchParams.set("r",a),window.history.replaceState({},"",r.toString()),window.dispatchEvent(new StorageEvent("storage",{key:"selection",newValue:JSON.stringify({p:e,c:t,r:a})}))}(0,n.useEffect)(()=>{fetch("/api/profiles").then(e=>e.json()).then(t).catch(()=>{}),fetch("/api/rooms").then(e=>e.json()).then(d).catch(()=>{});try{let t=new URL(window.location.href),a=t.searchParams.get("p"),r=t.searchParams.get("c"),n=t.searchParams.get("r"),l=localStorage.getItem("activeProfile");if(a&&e.length){let t=e.find(e=>e.id===a)||null;c(t),t&&localStorage.setItem("activeProfile",JSON.stringify(t))}else l&&c(JSON.parse(l));r&&m(r),n&&p(n)}catch(e){}},[]),(0,n.useEffect)(()=>{if(!o){s([]),w(void 0,void 0,void 0);return}fetch("/api/classes?profileId=".concat(o.id)).then(e=>e.json()).then(e=>{s(e),-1===e.findIndex(e=>e.id===h)&&m("")}),localStorage.setItem("activeProfile",JSON.stringify(o)),w(o.id,h||void 0,f||void 0)},[null==o?void 0:o.id]),(0,n.useEffect)(()=>{w(null==o?void 0:o.id,h||void 0,f||void 0)},[h,f]);let N=(0,n.useMemo)(()=>{var e;return null!==(e=null==o?void 0:o.name)&&void 0!==e?e:"Profil w\xe4hlen…"},[o]);return(0,r.jsx)("header",{className:"border-b border-neutral-900 bg-bg-soft/60 backdrop-blur",children:(0,r.jsxs)("div",{className:"container flex h-12 items-center justify-between gap-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(l.z,{"aria-label":"Sidebar umschalten",onClick:()=>{let e=!b;j(e),window.dispatchEvent(new StorageEvent("storage",{key:"sidebar",newValue:JSON.stringify({open:e})}))},children:"☰"}),(0,r.jsxs)("select",{value:(null==o?void 0:o.id)||"",onChange:t=>{if("__new__"===t.target.value){y(!0),g(!0);return}c(e.find(e=>e.id===t.target.value)||null)},className:"rounded bg-neutral-900 px-2 py-1 border border-neutral-800",children:[(0,r.jsx)("option",{value:"",children:N}),e.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id)),(0,r.jsx)("option",{value:"__new__",children:"+ Profil anlegen…"})]}),(0,r.jsxs)("select",{value:h,onChange:e=>m(e.target.value),disabled:!o,className:"rounded bg-neutral-900 px-2 py-1 border border-neutral-800 disabled:opacity-50",children:[(0,r.jsx)("option",{value:"",children:"Klasse w\xe4hlen…"}),a.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,r.jsxs)("select",{value:f,onChange:e=>p(e.target.value),className:"rounded bg-neutral-900 px-2 py-1 border border-neutral-800",children:[(0,r.jsx)("option",{value:"",children:"Raum w\xe4hlen…"}),i.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,r.jsx)(l.z,{"aria-label":"Einstellungen",onClick:()=>{y(!1),g(!0)},children:"⚙️"}),x&&(0,r.jsx)(u,{createMode:v,profile:v?null:o,onClose:async e=>{if(g(!1),e){let[e,a]=await Promise.all([fetch("/api/profiles").then(e=>e.json()),fetch("/api/rooms").then(e=>e.json())]);t(e),d(a),o&&s(await fetch("/api/classes?profileId=".concat(o.id)).then(e=>e.json()))}}})]})})}},3195:function(e,t,a){"use strict";a.d(t,{ImportStudents:function(){return s}});var r=a(7437),n=a(2265),l=a(7800);function s(){let[e,t]=(0,n.useState)([]),[a,s]=(0,n.useState)(!1),[i,d]=(0,n.useState)(null);async function o(e){s(!0),t([]),d(null);try{let t=await function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{timeoutMs:a=15e3,...r}=t,n=new AbortController,l=setTimeout(()=>n.abort(),a);return fetch(e,{...r,signal:n.signal}).finally(()=>clearTimeout(l))}("/api/import",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rows:e}),timeoutMs:15e3});if(!t.ok){let e=await t.text().catch(()=>""),a="Import fehlgeschlagen";try{let t=e?JSON.parse(e):null;a=(null==t?void 0:t.error)||a}catch(t){a=e||a}throw Error(a)}let a=await t.text(),r=a?JSON.parse(a):null;d(r)}catch(e){var a;t([(null==e?void 0:e.name)==="AbortError"||/aborted/i.test(String(null==e?void 0:e.message))?"Zeit\xfcberschreitung: Server nicht erreichbar (m\xf6gliche DB-Verbindung).":null!==(a=null==e?void 0:e.message)&&void 0!==a?a:"Import fehlgeschlagen"])}finally{s(!1)}}return(0,r.jsxs)("div",{className:"grid gap-6",children:[(0,r.jsxs)("div",{className:"grid gap-2",children:[(0,r.jsx)("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:function(e){var a;let r=null===(a=e.target.files)||void 0===a?void 0:a[0];if(!r)return;t([]),d(null);let n=new FileReader;n.onload=async()=>{let e=n.result;try{let t;if(!e)return;let a=(t="string"==typeof e?l.ij(e,{type:"string"}):l.ij(e,{type:"array"})).Sheets[t.SheetNames[0]],r=l.P6.sheet_to_json(a,{defval:""}).map(e=>{var t,a,r;return{foreName:String(null!==(t=e.foreName)&&void 0!==t?t:"").trim(),className:String(null!==(a=e["klasse.name"])&&void 0!==a?a:"").trim(),externalKey:String(null!==(r=e.externKey)&&void 0!==r?r:"").trim()}});await o(r)}catch(e){t([(null==e?void 0:e.message)||"Fehler beim Lesen der Datei"])}},r.name.toLowerCase().endsWith(".csv")?n.readAsText(r):n.readAsArrayBuffer(r)},className:"text-sm"}),(0,r.jsx)("p",{className:"text-xs text-fg-muted",children:"Erwartete Spalten (exakt): foreName, klasse.name, externKey. Der Import startet automatisch."}),a&&(0,r.jsx)("span",{className:"text-xs text-fg-muted",children:"Import l\xe4uft…"})]}),i&&(0,r.jsx)("div",{className:"rounded border border-neutral-900 bg-neutral-900/30 p-4 text-sm",children:(0,r.jsxs)("div",{className:"grid gap-1",children:[(0,r.jsxs)("div",{children:["Neu angelegte Sch\xfcler: ",(0,r.jsx)("span",{className:"text-primary",children:i.createdStudents})]}),(0,r.jsxs)("div",{children:["Aktualisierte Sch\xfcler: ",(0,r.jsx)("span",{className:"text-primary",children:i.updatedStudents})]}),(0,r.jsxs)("div",{children:["Neu angelegte Klassen: ",(0,r.jsx)("span",{className:"text-primary",children:i.createdClasses})]}),i.errors.length>0&&(0,r.jsxs)("div",{className:"mt-2 text-red-300",children:["Fehler: ",i.errors.length," – z. B. in Zeilen: ",i.errors.slice(0,5).map(e=>e.index+1).join(", "),i.errors.length>5?"…":""]})]})}),e.length>0&&(0,r.jsx)("div",{className:"rounded border border-red-900 bg-red-950/30 p-3 text-sm text-red-200",children:e.map((e,t)=>(0,r.jsx)("div",{children:e},t))})]})}},4308:function(e,t,a){"use strict";a.d(t,{z:function(){return n}});var r=a(7437);function n(e){let{variant:t="ghost",className:a="",...n}=e;return(0,r.jsx)("button",{className:"".concat("inline-flex items-center rounded px-3 py-2 text-sm transition-colors"," ").concat({primary:"bg-primary/20 text-primary hover:bg-primary/30",ghost:"bg-neutral-800 text-fg hover:bg-neutral-700",danger:"bg-red-900/40 text-red-300 hover:bg-red-900/60"}[t]," ").concat(a),...n})}a(2265)},8334:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r={modal:1e3,dropdown:950,toolbar:900,overlay:800}},8877:function(){}},function(e){e.O(0,[404,425,971,23,744],function(){return e(e.s=3717)}),_N_E=e.O()}]);