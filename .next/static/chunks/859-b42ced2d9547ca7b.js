(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[859],{9859:function(e,t,a){Promise.resolve().then(a.bind(a,9001))},9001:function(e,t,a){"use strict";a.d(t,{Editor:function(){return c}});var n=a(7437),r=a(2265),i=a(2932),l=a(4308);function s(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"id";return"".concat(e,"_").concat(Math.random().toString(36).slice(2,9))}function d(e,t){let a={left:e.x,top:e.y,right:e.x+e.w,bottom:e.y+e.h},n={left:t.x,top:t.y,right:t.x+t.w,bottom:t.y+t.h};return!(a.right<n.left||a.left>n.right||a.bottom<n.top||a.top>n.bottom)}function c(e){let{classes:t,rooms:c}=e,[o,h]=(0,r.useState)(null),[u,m]=(0,r.useState)(""),[x,p]=(0,r.useState)(""),[g,f]=(0,r.useState)(null),[b,v]=(0,r.useState)(null),[j,w]=(0,r.useState)("owner"),[y,N]=(0,r.useState)([]),[S,E]=(0,r.useState)([]),[z,I]=(0,r.useState)(null),[k,C]=(0,r.useState)("idle"),[D,P]=(0,r.useState)(!1),R=(0,r.useRef)(null);(0,r.useEffect)(()=>{let e=()=>{try{let e=localStorage.getItem("activeProfile");h(e?JSON.parse(e):null);let t=new URL(window.location.href),a=t.searchParams.get("c"),n=t.searchParams.get("r");a&&m(a),n&&p(n)}catch(e){h(null)}};e();let t=()=>e();return window.addEventListener("storage",t),window.addEventListener("storage",e=>{if("sidebar"===e.key&&e.newValue)try{let t=JSON.parse(e.newValue);P(!!t.open)}catch(e){}}),()=>window.removeEventListener("storage",t)},[]),(0,r.useEffect)(()=>{if(!u){E([]);return}fetch("/api/students?classId=".concat(u)).then(e=>e.json()).then(e=>{Array.isArray(e)&&E(e)}).catch(()=>E([]))},[u]);let T=(0,r.useCallback)(async e=>{if(!(null==o?void 0:o.id)||!u||!x)return;let t=await fetch("/api/plan?ownerProfileId=".concat(o.id,"&classId=").concat(u,"&roomId=").concat(x,"&create=").concat(e?"1":"0","&includeLead=1"));if(!t.ok)return;let a=await t.json();f(a.plan),v(a.leadPlan),N(a.plan.elements.map(e=>({...e}))),I(null)},[null==o?void 0:o.id,u,x]),L=(0,r.useCallback)(()=>{g&&(R.current&&clearTimeout(R.current),C("saving"),R.current=setTimeout(async()=>{try{await fetch("/api/plan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:g.id,elements:y})}),C("saved"),setTimeout(()=>C("idle"),1200)}catch(e){C("idle")}},900))},[g,y]),O=(0,r.useMemo)(()=>y.find(e=>e.id===z),[y,z]),_="lead"===j,A=(e,t,a)=>{_||N(n=>{let r=n.find(t=>t.id===e);if(!r)return n;let i=new Set((r.groupId?n.filter(e=>e.groupId===r.groupId):[r]).map(e=>e.id));return n.map(e=>i.has(e.id)?{...e,x:e.x+t,y:e.y+a}:e)})},W=e=>{_||(N(t=>{let a=t.find(t=>t.id===e);if(!a)return t;let n=a.groupId||null;for(let r of t)if(r.id!==e&&d(a,r)){n=n||r.groupId||s("grp");break}return n?t.map(t=>t.id===e||d(a,t)?{...t,groupId:n}:t):t.map(t=>t.id===e?{...t,groupId:null}:t)}),L())},K=(e,t)=>{if(_)return;let a={id:s("el"),type:e,refId:null!=t?t:null,x:120,y:120,w:80,h:50,rotation:0,z:y.length,groupId:null};("WINDOW_SIDE"===e||"WALL_SIDE"===e)&&(a.w=240,a.h=8),"DOOR"===e&&(a.w=36,a.h=8),"TEACHER_DESK"===e&&(a.w=200,a.h=60),N(e=>[...e,a]),L()},[M,G]=(0,r.useState)({w:1200,h:700}),F=(0,r.useRef)(null);(0,r.useEffect)(()=>{let e=F.current;if(!e)return;let t=new ResizeObserver(()=>{let t=e.getBoundingClientRect();G({w:Math.max(600,t.width),h:Math.max(400,t.height)})});return t.observe(e),()=>t.disconnect()},[]);let H=(0,r.useRef)(null);async function J(){if(!H.current)return;let{toPng:e}=await a.e(293).then(a.bind(a,7293)),t=await e(H.current,{cacheBust:!0,pixelRatio:2}),n=document.createElement("a");n.href=t,n.download="sitzplan-".concat(u,"-").concat(x,".png"),n.click()}async function B(){if(!H.current)return;let[{toPng:e},{jsPDF:t}]=await Promise.all([a.e(293).then(a.bind(a,7293)),Promise.all([a.e(505),a.e(65)]).then(a.bind(a,7501))]),n=await e(H.current,{cacheBust:!0,pixelRatio:2}),r=new t({orientation:"landscape",unit:"pt",format:"a4"}),i=r.internal.pageSize.getWidth(),l=r.internal.pageSize.getHeight(),s=new Image;s.src=n,await new Promise(e=>{s.onload=e});let d=Math.min(i/s.width,l/s.height),c=s.width*d,o=s.height*d;r.addImage(n,"PNG",(i-c)/2,(l-o)/2,c,o),r.save("sitzplan-".concat(u,"-").concat(x,".pdf"))}return(0,n.jsxs)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-5",children:[(0,n.jsxs)("div",{className:"lg:col-span-5 min-h-[60vh] rounded border border-neutral-900 bg-neutral-950/40 relative",children:[(0,n.jsxs)("div",{className:"pointer-events-auto absolute right-3 top-3 z-10 flex items-center gap-2 text-xs",children:[(0,n.jsx)(l.z,{onClick:()=>T(!0),variant:"primary",disabled:!o||!u||!x,children:"Plan laden/erstellen"}),b&&(0,n.jsxs)("div",{className:"ml-2 flex items-center gap-2",children:[(0,n.jsx)("span",{className:"text-fg-muted",children:"Ansicht:"}),(0,n.jsx)(l.z,{onClick:()=>w("owner"),className:"owner"===j?"bg-primary/20 text-primary":"",children:"Eigen"}),(0,n.jsx)(l.z,{onClick:()=>w("lead"),className:"lead"===j?"bg-primary/20 text-primary":"",children:"KL"})]}),(0,n.jsxs)("div",{className:"text-fg-muted",children:["saving"===k&&(0,n.jsx)("span",{className:"ml-3",children:"Speichern…"}),"saved"===k&&(0,n.jsx)("span",{className:"ml-3 text-primary",children:"Gespeichert"})]})]}),(0,n.jsx)("div",{ref:F,className:"relative h-[70vh] w-full overflow-auto",children:(0,n.jsx)("div",{ref:H,className:"relative",style:{width:M.w,height:M.h},children:("owner"===j?y:(null==b?void 0:b.elements)||[]).map(e=>(0,n.jsxs)("div",{role:"button",onClick:()=>!_&&I(e.id),className:"absolute select-none ".concat(z===e.id?"ring-2 ring-primary/60":""),"data-el":e.id,style:{left:e.x,top:e.y,width:e.w,height:e.h,transform:"rotate(".concat(e.rotation,"deg)"),zIndex:e.z},children:[(0,n.jsxs)("div",{className:"h-full w-full rounded border border-neutral-700 bg-neutral-800/60 flex items-center justify-center text-xs",children:["STUDENT"===e.type&&(0,n.jsxs)("span",{children:["Sch\xfcler",e.refId?"":" (leer)"]}),"TEACHER_DESK"===e.type&&(0,n.jsx)("span",{children:"Lehrerpult"}),"DOOR"===e.type&&(0,n.jsx)("span",{children:"T\xfcr"}),"WINDOW_SIDE"===e.type&&(0,n.jsx)("span",{children:"Fensterseite"}),"WALL_SIDE"===e.type&&(0,n.jsx)("span",{children:"Wandseite"})]}),!_&&z===e.id&&(0,n.jsx)(i.ZP,{target:()=>document.querySelector("[data-el='".concat(e.id,"']")),draggable:!0,resizable:!0,rotatable:!0,throttleDrag:0,throttleResize:0,throttleRotate:0,snappable:!0,snapThreshold:10,elementGuidelines:[],bounds:{left:0,top:0,right:M.w,bottom:M.h},onDrag:t=>{let a=t.beforeDelta[0],n=t.beforeDelta[1];A(e.id,a,n)},onDragEnd:()=>W(e.id),onResize:t=>{N(a=>a.map(a=>a.id===e.id?{...a,w:Math.max(10,t.width),h:Math.max(10,t.height),x:a.x+t.delta[0],y:a.y+t.delta[1]}:a))},onResizeEnd:()=>L(),onRotate:t=>{N(a=>a.map(a=>a.id===e.id?{...a,rotation:t.beforeRotate}:a))},onRotateEnd:()=>L()})]},e.id))})})]}),(0,n.jsxs)("aside",{className:"fixed left-0 top-[48px] z-20 h-[calc(100vh-48px)] w-72 transform border-r border-neutral-900 bg-bg-soft p-3 transition-transform ".concat(D?"translate-x-0":"-translate-x-full"),children:[(0,n.jsxs)("div",{className:"rounded border border-neutral-900 p-3 mb-3 grid gap-2",children:[(0,n.jsx)("div",{className:"text-sm font-medium mb-1",children:"Plan"}),(0,n.jsx)(l.z,{onClick:()=>T(!0),variant:"primary",disabled:!o||!u||!x,children:"Plan laden/erstellen"}),b&&(0,n.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[(0,n.jsx)("span",{className:"text-fg-muted",children:"Ansicht:"}),(0,n.jsx)(l.z,{onClick:()=>w("owner"),className:"owner"===j?"bg-primary/20 text-primary":"",children:"Eigen"}),(0,n.jsx)(l.z,{onClick:()=>w("lead"),className:"lead"===j?"bg-primary/20 text-primary":"",children:"KL"})]}),(0,n.jsxs)("div",{className:"text-xs text-fg-muted",children:["saving"===k&&(0,n.jsx)("span",{children:"Speichern…"}),"saved"===k&&(0,n.jsx)("span",{className:"text-primary",children:"Gespeichert"})]})]}),b&&"lead"===j&&(0,n.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,n.jsx)("div",{className:"text-sm font-medium",children:"KL-Plan"}),(0,n.jsx)("div",{className:"text-xs text-fg-muted",children:"Du kannst den Plan der Klassenleitung ansehen. \xc4nderungen sind hier nicht m\xf6glich."}),o&&(0,n.jsx)(l.z,{variant:"primary",onClick:async()=>{await fetch("/api/plan/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerProfileId:o.id,classId:u,roomId:x,sourcePlanId:b.id})}),w("owner"),await T(!1)},children:"Als Kopie \xfcbernehmen"})]}),(0,n.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[(0,n.jsx)("div",{className:"text-sm font-medium mb-2",children:"Palette"}),(0,n.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,n.jsx)(l.z,{onClick:()=>K("TEACHER_DESK"),children:"Lehrerpult"}),(0,n.jsx)(l.z,{onClick:()=>K("DOOR"),children:"T\xfcr"}),(0,n.jsx)(l.z,{onClick:()=>K("WINDOW_SIDE"),children:"Fensterseite"}),(0,n.jsx)(l.z,{onClick:()=>K("WALL_SIDE"),children:"Wandseite"})]})]}),(0,n.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[(0,n.jsx)("div",{className:"text-sm font-medium mb-2",children:"Sch\xfcler hinzuf\xfcgen"}),(0,n.jsxs)("div",{className:"grid gap-2 max-h-[260px] overflow-auto",children:[S.map(e=>(0,n.jsx)(l.z,{onClick:()=>K("STUDENT",e.id),className:"justify-start",children:e.foreName},e.id)),0===S.length&&(0,n.jsx)("div",{className:"text-xs text-fg-muted",children:"Keine Sch\xfcler geladen."})]})]}),(0,n.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,n.jsx)("div",{className:"text-sm font-medium",children:"Auswahl"}),!O&&(0,n.jsx)("div",{className:"text-xs text-fg-muted",children:"Nichts ausgew\xe4hlt"}),O&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"text-xs text-fg-muted",children:["Typ: ",O.type]}),(0,n.jsx)("div",{className:"flex gap-2",children:(0,n.jsx)(l.z,{onClick:()=>{!_&&z&&(N(e=>e.filter(e=>e.id!==z)),I(null),L())},variant:"danger",children:"L\xf6schen"})})]})]}),(0,n.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,n.jsx)("div",{className:"text-sm font-medium",children:"Export"}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(l.z,{onClick:J,children:"PNG"}),(0,n.jsx)(l.z,{onClick:B,children:"PDF (A4 Quer)"})]})]})]})]})}},4308:function(e,t,a){"use strict";a.d(t,{z:function(){return r}});var n=a(7437);function r(e){let{variant:t="ghost",className:a="",...r}=e;return(0,n.jsx)("button",{className:"".concat("inline-flex items-center rounded px-3 py-2 text-sm transition-colors"," ").concat({primary:"bg-primary/20 text-primary hover:bg-primary/30",ghost:"bg-neutral-800 text-fg hover:bg-neutral-700",danger:"bg-red-900/40 text-red-300 hover:bg-red-900/60"}[t]," ").concat(a),...r})}a(2265)}}]);