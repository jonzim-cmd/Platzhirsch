(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[859],{9859:function(e,t,n){Promise.resolve().then(n.bind(n,9001))},9001:function(e,t,n){"use strict";n.d(t,{Editor:function(){return c}});var r=n(7437),a=n(2265),l=n(2932),i=n(4308);function s(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"id";return"".concat(e,"_").concat(Math.random().toString(36).slice(2,9))}function d(e,t){let n={left:e.x,top:e.y,right:e.x+e.w,bottom:e.y+e.h},r={left:t.x,top:t.y,right:t.x+t.w,bottom:t.y+t.h};return!(n.right<r.left||n.left>r.right||n.bottom<r.top||n.top>r.bottom)}function c(e){var t,c,o,u;let{classes:h,rooms:m}=e,[x,p]=(0,a.useState)(null),[g,f]=(0,a.useState)(""),[v,b]=(0,a.useState)(""),[j,w]=(0,a.useState)(null),[N,y]=(0,a.useState)(null),[S,z]=(0,a.useState)("owner"),[E,I]=(0,a.useState)([]),[k,C]=(0,a.useState)([]),[D,P]=(0,a.useState)(null),[R,T]=(0,a.useState)("idle"),[L,O]=(0,a.useState)(!1),_=(0,a.useRef)(new Map),A=(0,a.useRef)(null);(0,a.useEffect)(()=>{let e=()=>{try{let e=localStorage.getItem("activeProfile");p(e?JSON.parse(e):null);let t=new URL(window.location.href),n=t.searchParams.get("c"),r=t.searchParams.get("r");n&&f(n),r&&b(r)}catch(e){p(null)}};e();let t=()=>e();return window.addEventListener("storage",t),window.addEventListener("storage",e=>{if("sidebar"===e.key&&e.newValue)try{let t=JSON.parse(e.newValue);O(!!t.open)}catch(e){}}),()=>window.removeEventListener("storage",t)},[]),(0,a.useEffect)(()=>{if(!g){C([]);return}fetch("/api/students?classId=".concat(g)).then(e=>e.json()).then(e=>{Array.isArray(e)&&C(e)}).catch(()=>C([]))},[g]);let M=(0,a.useCallback)(async e=>{if(!(null==x?void 0:x.id)||!g||!v)return;let t=await fetch("/api/plan?ownerProfileId=".concat(x.id,"&classId=").concat(g,"&roomId=").concat(v,"&create=").concat(e?"1":"0","&includeLead=1"));if(!t.ok)return;let n=await t.json();w(n.plan),y(n.leadPlan),I(n.plan.elements.map(e=>({...e}))),P(null)},[null==x?void 0:x.id,g,v]),W=(0,a.useCallback)(()=>{j&&(A.current&&clearTimeout(A.current),T("saving"),A.current=setTimeout(async()=>{try{await fetch("/api/plan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:j.id,elements:E})}),T("saved"),setTimeout(()=>T("idle"),1200)}catch(e){T("idle")}},900))},[j,E]),K=(0,a.useMemo)(()=>E.find(e=>e.id===D),[E,D]),G=(0,a.useMemo)(()=>{var e;return D&&null!==(e=_.current.get(D))&&void 0!==e?e:null},[D,E]),F=(0,a.useMemo)(()=>{let e=new Map;for(let t of k)e.set(t.id,t.foreName);return e},[k]),H="lead"===S,J=(e,t,n)=>{H||I(r=>{let a=r.find(t=>t.id===e);if(!a)return r;let l=new Set((a.groupId?r.filter(e=>e.groupId===a.groupId):[a]).map(e=>e.id));return r.map(e=>l.has(e.id)?{...e,x:e.x+t,y:e.y+n}:e)})},B=e=>{H||(I(t=>{let n=t.find(t=>t.id===e);if(!n)return t;let r=n.groupId||null;for(let a of t)if(a.id!==e&&d(n,a)){r=r||a.groupId||s("grp");break}return r?t.map(t=>t.id===e||d(n,t)?{...t,groupId:r}:t):t.map(t=>t.id===e?{...t,groupId:null}:t)}),W())},U=(e,t)=>{if(H)return;let n={id:s("el"),type:e,refId:null!=t?t:null,x:L?320:120,y:120,w:80,h:50,rotation:0,z:E.length,groupId:null,meta:{fontSize:12}};("WINDOW_SIDE"===e||"WALL_SIDE"===e)&&(n.w=240,n.h=8),"DOOR"===e&&(n.w=36,n.h=8),"TEACHER_DESK"===e&&(n.w=200,n.h=60),I(e=>[...e,n]),W()},[V,Q]=(0,a.useState)({w:1200,h:700}),Z=(0,a.useRef)(null);(0,a.useEffect)(()=>{let e=Z.current;if(!e)return;let t=new ResizeObserver(()=>{let t=e.getBoundingClientRect();Q({w:Math.max(600,t.width),h:Math.max(400,t.height)})});return t.observe(e),()=>t.disconnect()},[]);let q=(0,a.useRef)(null);async function X(){if(!q.current)return;let{toPng:e}=await n.e(293).then(n.bind(n,7293)),t=await e(q.current,{cacheBust:!0,pixelRatio:2}),r=document.createElement("a");r.href=t,r.download="sitzplan-".concat(g,"-").concat(v,".png"),r.click()}async function Y(){if(!q.current)return;let[{toPng:e},{jsPDF:t}]=await Promise.all([n.e(293).then(n.bind(n,7293)),Promise.all([n.e(505),n.e(65)]).then(n.bind(n,7501))]),r=await e(q.current,{cacheBust:!0,pixelRatio:2}),a=new t({orientation:"landscape",unit:"pt",format:"a4"}),l=a.internal.pageSize.getWidth(),i=a.internal.pageSize.getHeight(),s=new Image;s.src=r,await new Promise(e=>{s.onload=e});let d=Math.min(l/s.width,i/s.height),c=s.width*d,o=s.height*d;a.addImage(r,"PNG",(l-c)/2,(i-o)/2,c,o),a.save("sitzplan-".concat(g,"-").concat(v,".pdf"))}return(0,r.jsxs)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-5",children:[(0,r.jsxs)("div",{className:"lg:col-span-5 min-h-[60vh] rounded border border-neutral-900 bg-neutral-950/40 relative",children:[(0,r.jsxs)("div",{className:"pointer-events-auto absolute right-3 top-3 z-10 flex items-center gap-2 text-xs",children:[(0,r.jsx)(i.z,{onClick:()=>M(!0),variant:"primary",disabled:!x||!g||!v,children:"Plan laden/erstellen"}),N&&(0,r.jsxs)("div",{className:"ml-2 flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-fg-muted",children:"Ansicht:"}),(0,r.jsx)(i.z,{onClick:()=>z("owner"),className:"owner"===S?"bg-primary/20 text-primary":"",children:"Eigen"}),(0,r.jsx)(i.z,{onClick:()=>z("lead"),className:"lead"===S?"bg-primary/20 text-primary":"",children:"KL"})]}),(0,r.jsxs)("div",{className:"text-fg-muted",children:["saving"===R&&(0,r.jsx)("span",{className:"ml-3",children:"Speichern…"}),"saved"===R&&(0,r.jsx)("span",{className:"ml-3 text-primary",children:"Gespeichert"})]})]}),(0,r.jsx)("div",{ref:Z,className:"relative h-[70vh] w-full overflow-auto",children:(0,r.jsxs)("div",{ref:q,className:"relative",style:{width:V.w,height:V.h},onMouseDown:e=>{e.target===q.current&&P(null)},children:[("owner"===S?E:(null==N?void 0:N.elements)||[]).map(e=>{var t,n;return(0,r.jsx)("div",{role:"button",onClick:()=>!H&&P(e.id),className:"absolute select-none ".concat(D===e.id?"ring-2 ring-primary/60":""),"data-el":e.id,style:{left:e.x,top:e.y,width:e.w,height:e.h,transform:"rotate(".concat(e.rotation,"deg)"),zIndex:e.z},ref:t=>{t?_.current.set(e.id,t):_.current.delete(e.id)},children:(0,r.jsxs)("div",{className:"h-full w-full rounded border border-neutral-700 bg-neutral-800/60 flex items-center justify-center",style:{fontSize:(null!==(n=null===(t=e.meta)||void 0===t?void 0:t.fontSize)&&void 0!==n?n:12)+"px"},children:["STUDENT"===e.type&&(0,r.jsx)("span",{children:e.refId?F.get(String(e.refId))||"Sch\xfcler":"Sch\xfcler (leer)"}),"TEACHER_DESK"===e.type&&(0,r.jsx)("span",{children:"Lehrerpult"}),"DOOR"===e.type&&(0,r.jsx)("span",{children:"T\xfcr"}),"WINDOW_SIDE"===e.type&&(0,r.jsx)("span",{children:"Fensterseite"}),"WALL_SIDE"===e.type&&(0,r.jsx)("span",{children:"Wandseite"})]})},e.id)}),!H&&G&&(0,r.jsx)(l.ZP,{target:G,draggable:!0,resizable:!0,rotatable:!0,throttleDrag:0,throttleResize:0,throttleRotate:0,snappable:!0,snapThreshold:10,elementGuidelines:[],bounds:{left:0,top:0,right:V.w,bottom:V.h},onDrag:e=>{D&&J(D,e.beforeDelta[0],e.beforeDelta[1])},onDragEnd:()=>{D&&B(D)},onResize:e=>{D&&I(t=>t.map(t=>t.id===D?{...t,w:Math.max(10,e.width),h:Math.max(10,e.height),x:t.x+e.delta[0],y:t.y+e.delta[1]}:t))},onResizeEnd:()=>W(),onRotate:e=>{D&&I(t=>t.map(t=>t.id===D?{...t,rotation:e.beforeRotate}:t))},onRotateEnd:()=>W()})]})})]}),(0,r.jsxs)("aside",{className:"fixed left-0 top-[48px] z-20 h-[calc(100vh-48px)] w-72 transform border-r border-neutral-900 bg-bg-soft p-3 transition-transform ".concat(L?"translate-x-0":"-translate-x-full"),children:[(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3 mb-3 grid gap-2",children:[(0,r.jsx)("div",{className:"text-sm font-medium mb-1",children:"Plan"}),(0,r.jsx)(i.z,{onClick:()=>M(!0),variant:"primary",disabled:!x||!g||!v,children:"Plan laden/erstellen"}),N&&(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[(0,r.jsx)("span",{className:"text-fg-muted",children:"Ansicht:"}),(0,r.jsx)(i.z,{onClick:()=>z("owner"),className:"owner"===S?"bg-primary/20 text-primary":"",children:"Eigen"}),(0,r.jsx)(i.z,{onClick:()=>z("lead"),className:"lead"===S?"bg-primary/20 text-primary":"",children:"KL"})]}),(0,r.jsxs)("div",{className:"text-xs text-fg-muted",children:["saving"===R&&(0,r.jsx)("span",{children:"Speichern…"}),"saved"===R&&(0,r.jsx)("span",{className:"text-primary",children:"Gespeichert"})]})]}),N&&"lead"===S&&(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,r.jsx)("div",{className:"text-sm font-medium",children:"KL-Plan"}),(0,r.jsx)("div",{className:"text-xs text-fg-muted",children:"Du kannst den Plan der Klassenleitung ansehen. \xc4nderungen sind hier nicht m\xf6glich."}),x&&(0,r.jsx)(i.z,{variant:"primary",onClick:async()=>{await fetch("/api/plan/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerProfileId:x.id,classId:g,roomId:v,sourcePlanId:N.id})}),z("owner"),await M(!1)},children:"Als Kopie \xfcbernehmen"})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[(0,r.jsx)("div",{className:"text-sm font-medium mb-2",children:"Palette"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,r.jsx)(i.z,{onClick:()=>U("TEACHER_DESK"),children:"Lehrerpult"}),(0,r.jsx)(i.z,{onClick:()=>U("DOOR"),children:"T\xfcr"}),(0,r.jsx)(i.z,{onClick:()=>U("WINDOW_SIDE"),children:"Fensterseite"}),(0,r.jsx)(i.z,{onClick:()=>U("WALL_SIDE"),children:"Wandseite"})]})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[(0,r.jsx)("div",{className:"text-sm font-medium mb-2",children:"Sch\xfcler hinzuf\xfcgen"}),(0,r.jsxs)("div",{className:"grid gap-2 max-h-[260px] overflow-auto",children:[k.map(e=>(0,r.jsx)(i.z,{onClick:()=>U("STUDENT",e.id),className:"justify-start",children:e.foreName},e.id)),0===k.length&&(0,r.jsx)("div",{className:"text-xs text-fg-muted",children:"Keine Sch\xfcler geladen."})]})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,r.jsx)("div",{className:"text-sm font-medium",children:"Auswahl"}),!K&&(0,r.jsx)("div",{className:"text-xs text-fg-muted",children:"Nichts ausgew\xe4hlt"}),K&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"text-xs text-fg-muted",children:["Typ: ",K.type]}),(0,r.jsxs)("label",{className:"text-xs text-fg-muted flex items-center gap-2",children:[(0,r.jsx)("span",{children:"Schriftgr\xf6\xdfe"}),(0,r.jsx)("input",{type:"range",min:8,max:24,value:null!==(o=null===(t=K.meta)||void 0===t?void 0:t.fontSize)&&void 0!==o?o:12,onChange:e=>{let t=parseInt(e.target.value,10);I(e=>e.map(e=>e.id===K.id?{...e,meta:{...e.meta||{},fontSize:t}}:e)),W()}}),(0,r.jsxs)("span",{className:"tabular-nums",children:[null!==(u=null===(c=K.meta)||void 0===c?void 0:c.fontSize)&&void 0!==u?u:12,"px"]})]}),(0,r.jsx)("div",{className:"flex gap-2",children:(0,r.jsx)(i.z,{onClick:()=>{!H&&D&&(I(e=>e.filter(e=>e.id!==D)),P(null),W())},variant:"danger",children:"L\xf6schen"})})]})]}),(0,r.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,r.jsx)("div",{className:"text-sm font-medium",children:"Export"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)(i.z,{onClick:X,children:"PNG"}),(0,r.jsx)(i.z,{onClick:Y,children:"PDF (A4 Quer)"})]})]})]})]})}},4308:function(e,t,n){"use strict";n.d(t,{z:function(){return a}});var r=n(7437);function a(e){let{variant:t="ghost",className:n="",...a}=e;return(0,r.jsx)("button",{className:"".concat("inline-flex items-center rounded px-3 py-2 text-sm transition-colors"," ").concat({primary:"bg-primary/20 text-primary hover:bg-primary/30",ghost:"bg-neutral-800 text-fg hover:bg-neutral-700",danger:"bg-red-900/40 text-red-300 hover:bg-red-900/60"}[t]," ").concat(n),...a})}n(2265)}}]);