(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[859],{9859:function(e,t,a){Promise.resolve().then(a.bind(a,839))},839:function(e,t,a){"use strict";a.d(t,{Editor:function(){return y}});var i=a(7437),n=a(2265);function r(e,t,a,i){let n=Math.max(0,Math.min(1,i));return"left"===a?{left:-12,top:t*n-12}:"right"===a?{left:e-12,top:t*n-12}:"top"===a?{left:e*n-12,top:-12}:{left:e*n-12,top:t-12}}function l(e,t){let a=Math.max(0,Math.min(e.y+e.h,t.y+t.h)-Math.max(e.y,t.y)),i=Math.max(0,Math.min(e.x+e.w,t.x+t.w)-Math.max(e.x,t.x));if(a>0){if(.75>=Math.abs(e.x+e.w-t.x)){let a=Math.max(e.y,t.y),i=Math.min(e.y+e.h,t.y+t.h);return{aSide:"right",bSide:"left",aT:((a+i)/2-e.y)/e.h,bT:((a+i)/2-t.y)/t.h}}if(.75>=Math.abs(e.x-(t.x+t.w))){let a=Math.max(e.y,t.y),i=Math.min(e.y+e.h,t.y+t.h);return{aSide:"left",bSide:"right",aT:((a+i)/2-e.y)/e.h,bT:((a+i)/2-t.y)/t.h}}}if(i>0){if(.75>=Math.abs(e.y+e.h-t.y)){let a=Math.max(e.x,t.x),i=Math.min(e.x+e.w,t.x+t.w);return{aSide:"bottom",bSide:"top",aT:((a+i)/2-e.x)/e.w,bT:((a+i)/2-t.x)/t.w}}if(.75>=Math.abs(e.y-(t.y+t.h))){let a=Math.max(e.x,t.x),i=Math.min(e.x+e.w,t.x+t.w);return{aSide:"top",bSide:"bottom",aT:((a+i)/2-e.x)/e.w,bT:((a+i)/2-t.x)/t.w}}}let n=e.x+e.w/2,r=e.y+e.h/2,l=t.x+t.w/2,d=t.y+t.h/2,o=l-n,s=d-r;if(Math.abs(o)>Math.abs(s)){let a=Math.max(e.y,t.y),i=Math.min(e.y+e.h,t.y+t.h),n=((a+i)/2-e.y)/e.h,r=((a+i)/2-t.y)/t.h;return o>0?{aSide:"right",bSide:"left",aT:n,bT:r}:{aSide:"left",bSide:"right",aT:n,bT:r}}{let a=Math.max(e.x,t.x),i=Math.min(e.x+e.w,t.x+t.w),n=((a+i)/2-e.x)/e.w,r=((a+i)/2-t.x)/t.w;return s>0?{aSide:"bottom",bSide:"top",aT:n,bT:r}:{aSide:"top",bSide:"bottom",aT:n,bT:r}}}var d=a(2932),o=a(4308),s=a(8334);function u(e){let{elements:t,readOnly:a,onDetach:n,hoverCandidate:l,onCreate:d}=e;return a?null:(0,i.jsxs)("div",{className:"pointer-events-none absolute inset-0",style:{zIndex:s.Z.overlay},children:[l&&(()=>{let e=t.find(e=>e.id===l.aId);if(!e)return null;let a=r(e.w,e.h,l.aSide,"number"==typeof l.aT?l.aT:.5),n=e.x+a.left,o=e.y+a.top;return(0,i.jsx)("button",{type:"button",title:"Heftung erstellen",className:"absolute pointer-events-auto h-6 w-6 flex items-center justify-center text-neutral-500 hover:text-neutral-50",style:{left:n,top:o},onClick:e=>{e.stopPropagation(),null==d||d(l)},children:(0,i.jsxs)("svg",{viewBox:"0 0 24 24",className:"h-4 w-4",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"drop-shadow(0 0 1px rgba(0,0,0,0.85))"},children:[(0,i.jsx)("path",{d:"M8 11V8a4 4 0 118 0v3"}),(0,i.jsx)("rect",{x:"6.5",y:"11",width:"11",height:"8",rx:"2"})]})})})(),t.flatMap(e=>{var t;let a=e.id;return(Array.isArray(null===(t=e.meta)||void 0===t?void 0:t.joints)?e.meta.joints:[]).filter(e=>(a||"")<(e.otherId||"")).map(t=>{let l=r(e.w,e.h,t.side,"number"==typeof t.t?t.t:.5),d=e.x+l.left,o=e.y+l.top;return(0,i.jsx)("button",{type:"button",title:"Heftung l\xf6sen",className:"absolute pointer-events-auto h-6 w-6 flex items-center justify-center text-neutral-200 hover:text-neutral-50",style:{left:d,top:o},onClick:e=>{e.stopPropagation(),n(a,t.otherId)},children:(0,i.jsxs)("svg",{viewBox:"0 0 24 24",className:"h-4 w-4",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{filter:"drop-shadow(0 0 1px rgba(0,0,0,0.85))"},children:[(0,i.jsx)("path",{d:"M8 11V8a4 4 0 118 0v3"}),(0,i.jsx)("rect",{x:"6.5",y:"11",width:"11",height:"8",rx:"2"}),(0,i.jsx)("path",{d:"M12 14v2"})]})},"".concat(a,"-").concat(t.otherId))})})]})}var h=a(4887);function m(e){let{children:t}=e;return"undefined"==typeof document?null:(0,h.createPortal)(t,document.body)}function c(e){var t,a,n,r,l;let{ctx:h}=e,{leadPlan:c,viewMode:f,setViewMode:x,saving:p,frameRef:y,canvasRef:v,frameSize:g,readOnly:w,elements:b,selectedIds:M,setSelectedIds:I,elementRefs:S,selected:j,studentById:N,defaultTerms:T,pickerOpenId:E,setPickerOpenId:D,pickerQuery:k,setPickerQuery:A,usedStudentIds:z,addElement:C,applyPairsLayout:L,removeJoint:R,scheduleSave:O,exportPng:W,exportPdf:_,selectedTarget:P,primarySelectedId:U,moveElementBy:K,onDragEnd:B,setElements:H,students:J,classId:q,roomId:X,loadPlan:F}=h;return(0,i.jsxs)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-5",children:[(0,i.jsxs)("div",{className:"lg:col-span-5 h-[calc(100vh-48px)] rounded border border-neutral-900 bg-neutral-950/40 relative",children:[(0,i.jsxs)("div",{className:"pointer-events-auto absolute right-3 top-3 flex items-center gap-2 text-xs",style:{zIndex:s.Z.toolbar},children:[c&&(0,i.jsxs)("div",{className:"ml-2 flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-fg-muted",children:"Ansicht:"}),(0,i.jsx)(o.z,{onClick:()=>x("owner"),className:"owner"===f?"bg-primary/20 text-primary":"",children:"Eigen"}),(0,i.jsx)(o.z,{onClick:()=>x("lead"),className:"lead"===f?"bg-primary/20 text-primary":"",children:"KL"})]}),(0,i.jsxs)("div",{className:"text-fg-muted",children:["saving"===p&&(0,i.jsx)("span",{className:"ml-3",children:"Speichern…"}),"saved"===p&&(0,i.jsx)("span",{className:"ml-3 text-primary",children:"Gespeichert"})]})]}),(0,i.jsx)("div",{ref:y,className:"relative h-full w-full overflow-auto",children:(0,i.jsxs)("div",{ref:v,className:"relative",style:{width:g.w,height:g.h},onMouseDown:e=>{if(!w&&e.target===v.current){let t=e.currentTarget.getBoundingClientRect(),a=e.clientX-t.left,i=e.clientY-t.top;if("function"==typeof h.tryCreateJointAt&&h.tryCreateJointAt(a,i))return;h.setMarquee({active:!0,x0:a,y0:i,x1:a,y1:i}),I([]);let n=e=>{let n=e.clientX-t.left,r=e.clientY-t.top;h.setMarquee(e=>({...e,x1:n,y1:r}));let l=Math.min(a,n),d=Math.min(i,r),o=Math.max(a,n),s=Math.max(i,r),u=(e,t,a,i,n,r,l,d)=>!(a<n||e>l||i<r||t>d);I(b.filter(e=>{let t=((e.rotation||0)%360+360)%360*Math.PI/180,a=Math.cos(t),i=Math.sin(t),n=Math.abs(e.w*a)+Math.abs(e.h*i),r=Math.abs(e.w*i)+Math.abs(e.h*a),h=e.x+e.w/2,m=e.y+e.h/2,c=h-n/2,f=m-r/2,x=h+n/2,p=m+r/2;return"DOOR"===e.type||"WINDOW_SIDE"===e.type||"WALL_SIDE"===e.type?u(c,f,x,p,l,d,o,s):c>=l&&f>=d&&x<=o&&p<=s}).map(e=>e.id))},r=e=>{let a=e.clientX-t.left,i=e.clientY-t.top;h.setMarquee(e=>({...e,active:!1,x1:a,y1:i})),window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",r)};window.addEventListener("mousemove",n),window.addEventListener("mouseup",r)}},onMouseMove:e=>{var t;if(w||!v.current)return;let a=e.currentTarget.getBoundingClientRect(),i=e.clientX-a.left,n=e.clientY-a.top;null===(t=h.updateJointHover)||void 0===t||t.call(h,i,n)},onMouseLeave:()=>{var e;w||null===(e=h.setJointHover)||void 0===e||e.call(h,null)},children:[("owner"===f?b:(null==c?void 0:c.elements)||[]).map(e=>{var t,a,n,r,l,d,o;return(0,i.jsx)("div",{role:"button",onMouseDown:t=>{if(w)return;let a=e.id;M.includes(a)&&I(e=>[a,...e.filter(e=>e!==a)])},onClick:t=>{w||(t.metaKey||t.ctrlKey?I(t=>t.includes(e.id)?t.filter(t=>t!==e.id):[...t,e.id]):I([e.id]))},className:"absolute select-none ".concat(M.includes(e.id)?"ring-2 ring-primary/60":""),"data-el":e.id,style:{left:e.x,top:e.y,width:e.w,height:e.h,transform:"rotate(".concat(e.rotation,"deg)"),zIndex:e.z},ref:t=>{t?S.current.set(e.id,t):S.current.delete(e.id)},children:(0,i.jsxs)("div",{className:"h-full w-full ".concat("TEACHER_DESK"===e.type?"rounded-xl":"rounded"," border ").concat("WINDOW_SIDE"===e.type?"border-sky-700 bg-sky-900/30 border-dashed":"WALL_SIDE"===e.type?"border-neutral-600 bg-neutral-700/60":"border-neutral-700 bg-neutral-800/60"," flex items-center justify-center px-1"),style:{fontSize:(null!==(o=null===(t=e.meta)||void 0===t?void 0:t.fontSize)&&void 0!==o?o:20)+"px"},onDoubleClick:t=>{var a,i;if(w)return;t.stopPropagation();let n="";n="STUDENT"===e.type?e.refId?N.get(String(e.refId))||"":(null===(a=e.meta)||void 0===a?void 0:a.label)||"":(null===(i=e.meta)||void 0===i?void 0:i.label)||T[e.type],h.setEditing({id:e.id,value:n})},children:[!w&&"STUDENT"===e.type&&(0,i.jsxs)("div",{className:"absolute left-0 top-0 z-10",children:[(0,i.jsx)("button",{type:"button",className:"h-7 w-7 flex items-start justify-start text-[14px] leading-none text-neutral-400 hover:text-neutral-200 bg-transparent pl-1 pt-0.5",title:"Sch\xfcler ausw\xe4hlen",onClick:t=>{t.stopPropagation(),D(E===e.id?null:e.id),A("")},children:"▾"}),E===e.id&&(()=>{var t,a;let n=S.current.get(e.id),r=null==n?void 0:n.getBoundingClientRect(),l=(null!==(t=null==r?void 0:r.left)&&void 0!==t?t:0)+window.scrollX,d=(null!==(a=null==r?void 0:r.top)&&void 0!==a?a:0)+window.scrollY+28;return(0,i.jsx)(m,{children:(0,i.jsxs)("div",{className:"fixed w-56 rounded border border-neutral-800 bg-neutral-900 shadow-lg p-1 grid gap-1 text-sm max-h-64 overflow-auto",style:{left:l,top:d,zIndex:s.Z.dropdown},onClick:e=>e.stopPropagation(),children:[(0,i.jsx)("input",{autoFocus:!0,placeholder:"Suchen…",className:"w-full rounded border border-neutral-800 bg-neutral-950 px-2 py-1 text-xs",value:k,onChange:e=>A(e.target.value)}),(0,i.jsx)("button",{className:"w-full text-left rounded px-2 py-1 hover:bg-neutral-800",onClick:()=>{H(t=>t.map(t=>t.id===e.id?{...t,refId:null}:t)),D(null),O()},children:"– Leer –"}),J.filter(e=>e.foreName.toLowerCase().includes(k.toLowerCase())).map(t=>{let a=z.has(String(t.id))&&e.refId!==t.id;return(0,i.jsxs)("button",{disabled:a,className:"w-full text-left rounded px-2 py-1 hover:bg-neutral-800 ".concat(a?"opacity-60 cursor-not-allowed":""),onClick:()=>{a||(H(a=>a.map(a=>a.id===e.id?{...a,refId:t.id}:a)),D(null),O())},children:[t.foreName," ",e.refId===t.id&&"✓"," ",a&&"✔"]},t.id)})]})})})()]}),(null===(a=h.editing)||void 0===a?void 0:a.id)===e.id?(0,i.jsx)("input",{autoFocus:!0,className:"w-full bg-transparent text-center outline-none caret-primary",value:h.editing.value,onClick:e=>e.stopPropagation(),onChange:e=>h.setEditing(t=>({...t,value:e.target.value})),onKeyDown:null===(n=h.onInlineEditKeyDown)||void 0===n?void 0:n.bind(null,e),onBlur:null===(r=h.onInlineEditBlur)||void 0===r?void 0:r.bind(null,e)}):(0,i.jsx)("span",{className:"truncate w-full text-center",children:"STUDENT"===e.type?e.refId?N.get(String(e.refId))||"Sch\xfcler":(null===(l=e.meta)||void 0===l?void 0:l.label)||"leer":(null===(d=e.meta)||void 0===d?void 0:d.label)||T[e.type]})]})},e.id)}),(null===(t=h.marquee)||void 0===t?void 0:t.active)&&(0,i.jsx)("div",{className:"absolute border border-primary/60 bg-primary/10 pointer-events-none",style:{left:Math.min(h.marquee.x0,h.marquee.x1),top:Math.min(h.marquee.y0,h.marquee.y1),width:Math.abs(h.marquee.x1-h.marquee.x0),height:Math.abs(h.marquee.y1-h.marquee.y0)}}),!w&&P&&(0,i.jsx)(d.ZP,{target:P,draggable:!0,resizable:!0,rotatable:!0,throttleDrag:0,throttleResize:0,throttleRotate:0,snappable:!0,snapThreshold:8,elementGuidelines:Array.from(S.current.entries()).filter(e=>{let[t]=e;return!M.includes(t)}).map(e=>{let[t,a]=e;return a}),bounds:{left:0,top:0,right:g.w,bottom:g.h},origin:!1,renderDirections:(()=>{if(j&&("DOOR"===j.type||"WINDOW_SIDE"===j.type||"WALL_SIDE"===j.type))return Math.round((j.rotation%360+360)%360/90)%2==0?["e","w"]:["n","s"]})(),onDrag:e=>{U&&(K(U,e.beforeDelta[0],e.beforeDelta[1]),window.__lastMoveableEvent=e.inputEvent)},onDragStart:e=>{if(h.detachOnDragRef.current=!1,window.__lastMoveableEvent=e.inputEvent,!U)return;let t=new Map(b.map(e=>[e.id,e])),a=[...M.includes(U)?M:[U]],i=new Set;for(;a.length;){var n;let e=a.pop();if(i.has(e))continue;i.add(e);let r=t.get(e);for(let e of Array.isArray(null==r?void 0:null===(n=r.meta)||void 0===n?void 0:n.joints)?r.meta.joints:[])i.has(e.otherId)||a.push(e.otherId)}for(let e of(h.dragStartPositions.current.clear(),i)){let a=t.get(e);a&&h.dragStartPositions.current.set(e,{x:a.x,y:a.y})}},onDragEnd:()=>{U&&B(U,{detach:h.detachOnDragRef.current})},onResizeStart:e=>{var t,a;null===(a=e.setKeepRatio)||void 0===a||a.call(e,(null===(t=e.inputEvent)||void 0===t?void 0:t.shiftKey)===!0)},onResize:h.onMoveableResize,onResizeEnd:()=>O(),onRotate:e=>{U&&H(t=>t.map(t=>t.id===U?{...t,rotation:e.beforeRotate}:t))},onRotateEnd:()=>O()}),(0,i.jsx)(u,{elements:b,readOnly:w,hoverCandidate:h.jointHover,onCreate:e=>{var t;return null===(t=h.createJointFromCandidate)||void 0===t?void 0:t.call(h,e)},onDetach:(e,t)=>{R(e,t),O()}})]})})]}),(0,i.jsxs)("aside",{className:"fixed left-0 top-[48px] h-[calc(100vh-48px)] w-72 transform border-r border-neutral-900 bg-bg-soft p-3 overflow-auto transition-transform ".concat(h.sidebarOpen?"translate-x-0":"-translate-x-full"),style:{zIndex:s.Z.toolbar},children:[(0,i.jsxs)("div",{className:"rounded border border-neutral-900 p-3 mb-3 grid gap-2",children:[(0,i.jsx)("div",{className:"text-sm font-medium mb-1",children:"Plan"}),c&&(0,i.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[(0,i.jsx)("span",{className:"text-fg-muted",children:"Ansicht:"}),(0,i.jsx)(o.z,{onClick:()=>x("owner"),className:"owner"===f?"bg-primary/20 text-primary":"",children:"Eigen"}),(0,i.jsx)(o.z,{onClick:()=>x("lead"),className:"lead"===f?"bg-primary/20 text-primary":"",children:"KL"})]}),(0,i.jsxs)("div",{className:"text-xs text-fg-muted",children:["saving"===p&&(0,i.jsx)("span",{children:"Speichern…"}),"saved"===p&&(0,i.jsx)("span",{className:"text-primary",children:"Gespeichert"})]})]}),c&&"lead"===f&&(0,i.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,i.jsx)("div",{className:"text-sm font-medium",children:"KL-Plan"}),(0,i.jsx)("div",{className:"text-xs text-fg-muted",children:"Du kannst den Plan der Klassenleitung ansehen. \xc4nderungen sind hier nicht m\xf6glich."}),h.activeProfile&&(0,i.jsx)(o.z,{variant:"primary",onClick:async()=>{await fetch("/api/plan/copy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerProfileId:h.activeProfile.id,classId:q,roomId:X,sourcePlanId:c.id})}),x("owner"),await F(!1)},children:"Als Kopie \xfcbernehmen"})]}),(0,i.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[(0,i.jsx)("div",{className:"text-sm font-medium mb-2",children:"Palette"}),(0,i.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,i.jsx)(o.z,{onClick:()=>C("TEACHER_DESK"),children:"Lehrerpult"}),(0,i.jsx)(o.z,{onClick:()=>C("DOOR"),children:"T\xfcr"}),(0,i.jsx)(o.z,{onClick:()=>C("WINDOW_SIDE"),children:"Fenster"}),(0,i.jsx)(o.z,{onClick:()=>C("WALL_SIDE"),children:"Wand"}),(0,i.jsx)(o.z,{onClick:L,variant:"primary",children:"Paare-Layout anwenden"})]})]}),(0,i.jsxs)("div",{className:"rounded border border-neutral-900 p-3",children:[(0,i.jsx)("div",{className:"text-sm font-medium mb-2",children:"Sch\xfcler hinzuf\xfcgen"}),(0,i.jsxs)("div",{className:"grid gap-2 max-h-[260px] overflow-auto",children:[J.map(e=>(0,i.jsxs)(o.z,{onClick:()=>C("STUDENT",e.id),className:"justify-start ".concat(z.has(String(e.id))?"opacity-60":""),disabled:z.has(String(e.id)),children:[(0,i.jsx)("span",{className:"flex-1 text-left",children:e.foreName}),z.has(String(e.id))&&(0,i.jsx)("span",{className:"text-green-400",children:"✔"})]},e.id)),0===J.length&&(0,i.jsx)("div",{className:"text-xs text-fg-muted",children:"Keine Sch\xfcler geladen."})]})]}),(0,i.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,i.jsx)("div",{className:"text-sm font-medium",children:"Auswahl"}),!j&&(0,i.jsx)("div",{className:"text-xs text-fg-muted",children:"Nichts ausgew\xe4hlt"}),j&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"text-xs text-fg-muted",children:["Typ: ",j.type]}),(0,i.jsxs)("label",{className:"text-xs text-fg-muted flex items-center gap-2",children:[(0,i.jsx)("span",{children:"Schriftgr\xf6\xdfe"}),(0,i.jsx)("input",{type:"range",min:8,max:24,value:null!==(r=null===(a=j.meta)||void 0===a?void 0:a.fontSize)&&void 0!==r?r:12,onChange:e=>{let t=parseInt(e.target.value,10),a=new Set(M);H(e=>e.map(e=>a.has(e.id)?{...e,meta:{...e.meta||{},fontSize:t}}:e)),O()}}),(0,i.jsxs)("span",{className:"tabular-nums",children:[null!==(l=null===(n=j.meta)||void 0===n?void 0:n.fontSize)&&void 0!==l?l:12,"px"]})]}),(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsx)(o.z,{onClick:()=>{let e=new Set(M);H(t=>t.map(t=>{var a;if(!e.has(t.id))return t;let i=(Array.isArray(null===(a=t.meta)||void 0===a?void 0:a.joints)?t.meta.joints:[]).filter(t=>!e.has(t.otherId));return{...t,meta:{...t.meta||{},joints:i}}})),H(t=>t.map(t=>{var a;let i=(Array.isArray(null===(a=t.meta)||void 0===a?void 0:a.joints)?t.meta.joints:[]).filter(a=>!e.has(t.id)||!e.has(a.otherId));return{...t,meta:{...t.meta||{},joints:i}}})),O()},children:"Verbindungen der Auswahl l\xf6sen"})}),(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsx)(o.z,{onClick:()=>{var e,t;let a=null!==(t=null==j?void 0:null===(e=j.meta)||void 0===e?void 0:e.fontSize)&&void 0!==t?t:20,i=new Set(b.filter(e=>M.includes(e.id)).map(e=>e.type));h.setTypeStyles(e=>{let t={...e};for(let e of i)t[e]={fontSize:a};return t}),H(e=>e.map(e=>i.has(e.type)?{...e,meta:{...e.meta||{},fontSize:a}}:e)),O()},children:"Auf alle Typen in Auswahl anwenden"})}),(0,i.jsx)("div",{className:"flex gap-2",children:(0,i.jsx)(o.z,{onClick:h.removeSelected,variant:"danger",children:"L\xf6schen"})})]})]}),(0,i.jsxs)("div",{className:"rounded border border-neutral-900 p-3 grid gap-2",children:[(0,i.jsx)("div",{className:"text-sm font-medium",children:"Export"}),(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsx)(o.z,{onClick:W,children:"PNG"}),(0,i.jsx)(o.z,{onClick:_,children:"PDF (A4 Quer)"})]})]})]})]})}function f(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"id";return"".concat(e,"_").concat(Math.random().toString(36).slice(2,9))}function x(e,t,a,i){return Math.max(0,Math.min(t,i)-Math.max(e,a))}function p(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;if(!e||!t)return!1;let i=x(e.y,e.y+e.h,t.y,t.y+t.h),n=x(e.x,e.x+e.w,t.x,t.x+t.w);return!!(i>0&&Math.abs(e.x+e.w-t.x)<=a||i>0&&Math.abs(e.x-(t.x+t.w))<=a||n>0&&Math.abs(e.y+e.h-t.y)<=a||n>0&&Math.abs(e.y-(t.y+t.h))<=a)||function(e,t){let a={left:e.x,top:e.y,right:e.x+e.w,bottom:e.y+e.h},i={left:t.x,top:t.y,right:t.x+t.w,bottom:t.y+t.h};return!(a.right<i.left||a.left>i.right||a.bottom<i.top||a.top>i.bottom)}(e,t)}function y(e){var t;let{classes:r,rooms:d}=e,[o,s]=(0,n.useState)(null),[u,h]=(0,n.useState)(""),[m,y]=(0,n.useState)(""),[v,g]=(0,n.useState)(null),w=(0,n.useRef)(null),[b,M]=(0,n.useState)(null),[I,S]=(0,n.useState)("owner"),[j,N]=(0,n.useState)([]),T=(0,n.useRef)([]),[E,D]=(0,n.useState)([]),[k,A]=(0,n.useState)([]),[z,C]=(0,n.useState)("idle"),[L,R]=(0,n.useState)(!1),O=(0,n.useRef)(new Map),W=(0,n.useRef)(null),[_,P]=(0,n.useState)(null),[U,K]=(0,n.useState)({STUDENT:{fontSize:20},TEACHER_DESK:{fontSize:20},DOOR:{fontSize:20},WINDOW_SIDE:{fontSize:20},WALL_SIDE:{fontSize:20}}),[B,H]=(0,n.useState)({active:!1,x0:0,y0:0,x1:0,y1:0}),[J,q]=(0,n.useState)({id:null,value:""}),[X,F]=(0,n.useState)(null),[Y,Z]=(0,n.useState)(""),G=(0,n.useRef)(!1),V=(0,n.useRef)(new Map);(0,n.useRef)(!1);let[Q,$]=(0,n.useState)(null);function ee(e,t){N(a=>a.map(a=>{var i,n;if(a.id===e){let e=(Array.isArray(null===(i=a.meta)||void 0===i?void 0:i.joints)?a.meta.joints:[]).filter(e=>e.otherId!==t);return{...a,meta:{...a.meta||{},joints:e}}}if(a.id===t){let t=(Array.isArray(null===(n=a.meta)||void 0===n?void 0:n.joints)?a.meta.joints:[]).filter(t=>t.otherId!==e);return{...a,meta:{...a.meta||{},joints:t}}}return a}))}(0,n.useEffect)(()=>{w.current=v},[v]),(0,n.useEffect)(()=>{T.current=j},[j]),(0,n.useEffect)(()=>{let e=()=>{try{let e=localStorage.getItem("activeProfile");s(e?JSON.parse(e):null);let t=new URL(window.location.href),a=t.searchParams.get("c"),i=t.searchParams.get("r");a&&h(a),i&&y(i)}catch(e){s(null)}};e();let t=()=>e();return window.addEventListener("storage",t),window.addEventListener("storage",e=>{if("sidebar"===e.key&&e.newValue)try{let t=JSON.parse(e.newValue);R(!!t.open)}catch(e){}}),()=>window.removeEventListener("storage",t)},[]),(0,n.useEffect)(()=>{if(!u){D([]);return}fetch("/api/students?classId=".concat(u)).then(e=>e.json()).then(e=>{Array.isArray(e)&&D(e)}).catch(()=>D([]))},[u]);let et=(0,n.useCallback)(async e=>{if(!(null==o?void 0:o.id)||!u||!m)return;let t=await fetch("/api/plan?ownerProfileId=".concat(o.id,"&classId=").concat(u,"&roomId=").concat(m,"&create=").concat(e?"1":"0","&includeLead=1"));if(!t.ok)return;let a=await t.json();g(a.plan),M(a.leadPlan),N((e=>{let t=new Map,a=new Map;for(let n of e){var i;t.set(n.id,n);let e=Array.isArray(null===(i=n.meta)||void 0===i?void 0:i.joints)?n.meta.joints:[];a.set(n.id,e.map(e=>{var t,a;return{otherId:String(e.otherId),side:e.side,t:Number(e.t)||0,kind:null!==(t=e.kind)&&void 0!==t?t:void 0,pairId:null!==(a=e.pairId)&&void 0!==a?a:void 0}}))}let n=new Map;for(let t of e)t.groupId&&(n.has(t.groupId)||n.set(t.groupId,[]),n.get(t.groupId).push(t));for(let[,e]of n)for(let t=0;t<e.length;t++)for(let i=t+1;i<e.length;i++){let n=e[t],r=e[i];if(!p(n,r))continue;let d=l({x:n.x,y:n.y,w:n.w,h:n.h},{x:r.x,y:r.y,w:r.w,h:r.h});if(!d)continue;let o=a.get(n.id),s=a.get(r.id);o.some(e=>e.otherId===r.id)||o.push({otherId:r.id,side:d.aSide,t:d.aT,kind:"struct"}),s.some(e=>e.otherId===n.id)||s.push({otherId:n.id,side:d.bSide,t:d.bT,kind:"struct"})}return(()=>{for(let r of e){var i,n;if("STUDENT"!==r.type)continue;let e=(a.get(r.id)||[]).filter(e=>{let a=t.get(e.otherId);return(null==a?void 0:a.type)==="STUDENT"});if(1!==e.length)continue;let l=e[0],d=t.get(l.otherId),o=(a.get(d.id)||[]).find(e=>e.otherId===r.id);if(!o)continue;let s=null!==(n=null!==(i=l.pairId)&&void 0!==i?i:o.pairId)&&void 0!==n?n:f("pair");l.kind="pair",l.pairId=s,o.kind="pair",o.pairId=s}})(),e.map(e=>({...e,groupId:null,meta:{...e.meta||{},joints:a.get(e.id)}}))})(a.plan.elements.map(e=>({...e})))),A([]),setTimeout(()=>ea(),0)},[null==o?void 0:o.id,u,m]);(0,n.useEffect)(()=>{(null==o?void 0:o.id)&&u&&m&&et(!0)},[null==o?void 0:o.id,u,m,et]);let ea=(0,n.useCallback)(()=>{w.current&&(W.current&&clearTimeout(W.current),C("saving"),W.current=setTimeout(async()=>{try{if(!(await fetch("/api/plan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:w.current.id,elements:T.current})})).ok)throw Error("save failed");C("saved"),setTimeout(()=>C("idle"),1200)}catch(e){C("idle")}},900))},[]),ei=null!==(t=k[0])&&void 0!==t?t:null,en=(0,n.useMemo)(()=>ei?j.find(e=>e.id===ei):void 0,[j,ei]),er=(0,n.useMemo)(()=>{var e;return ei&&null!==(e=O.current.get(ei))&&void 0!==e?e:null},[ei,j]),el=(0,n.useMemo)(()=>{let e=new Map;for(let t of E)e.set(t.id,t.foreName);return e},[E]),ed="lead"===I,eo=(0,n.useMemo)(()=>{let e=new Set;for(let t of j)"STUDENT"===t.type&&t.refId&&e.add(String(t.refId));return e},[j]),es=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:12;if(ed)return null;let i=null,n=j.length;for(let r=0;r<n;r++){let l=j[r];for(let d=r+1;d<n;d++){let n=j[d],r=Math.max(l.y,n.y),o=Math.min(l.y+l.h,n.y+n.h);if(Math.max(0,o-r)>0){let d=l.x+l.w,s=n.x,u=n.x+n.w,h=l.x;if(Math.abs(d-s)<=a){let u=Math.abs(e-(d+s)/2);if(t>=r-a&&t<=o+a&&u<=a){let e=(Math.min(Math.max(t,l.y),l.y+l.h)-l.y)/l.h,a=(Math.min(Math.max(t,n.y),n.y+n.h)-n.y)/n.h,r={aId:l.id,bId:n.id,aSide:"right",bSide:"left",aT:e,bT:a,dist:u};(!i||u<i.dist)&&(i=r)}}if(Math.abs(u-h)<=a){let d=Math.abs(e-(u+h)/2);if(t>=r-a&&t<=o+a&&d<=a){let e=(Math.min(Math.max(t,l.y),l.y+l.h)-l.y)/l.h,a=(Math.min(Math.max(t,n.y),n.y+n.h)-n.y)/n.h,r={aId:l.id,bId:n.id,aSide:"left",bSide:"right",aT:e,bT:a,dist:d};(!i||d<i.dist)&&(i=r)}}}let s=Math.max(l.x,n.x),u=Math.min(l.x+l.w,n.x+n.w);if(Math.max(0,u-s)>0){let r=l.y+l.h,d=n.y,o=n.y+n.h,h=l.y;if(Math.abs(r-d)<=a){let o=Math.abs(t-(r+d)/2);if(e>=s-a&&e<=u+a&&o<=a){let t=(Math.min(Math.max(e,l.x),l.x+l.w)-l.x)/l.w,a=(Math.min(Math.max(e,n.x),n.x+n.w)-n.x)/n.w,r={aId:l.id,bId:n.id,aSide:"bottom",bSide:"top",aT:t,bT:a,dist:o};(!i||o<i.dist)&&(i=r)}}if(Math.abs(o-h)<=a){let r=Math.abs(t-(o+h)/2);if(e>=s-a&&e<=u+a&&r<=a){let t=(Math.min(Math.max(e,l.x),l.x+l.w)-l.x)/l.w,a=(Math.min(Math.max(e,n.x),n.x+n.w)-n.x)/n.w,d={aId:l.id,bId:n.id,aSide:"top",bSide:"bottom",aT:t,bT:a,dist:r};(!i||r<i.dist)&&(i=d)}}}}}return i?{aId:i.aId,bId:i.bId,aSide:i.aSide,bSide:i.bSide,aT:i.aT,bT:i.bT}:null},eu=e=>{var t,a,i,n,r,l;t=e.aId,a=e.bId,i=e.aSide,n=e.bSide,r=e.aT,l=e.bT,N(e=>{let d=e.find(e=>e.id===t),o=e.find(e=>e.id===a),s=(null==d?void 0:d.type)==="STUDENT"&&(null==o?void 0:o.type)==="STUDENT"&&("left"===i&&"right"===n||"right"===i&&"left"===n||"top"===i&&"bottom"===n||"bottom"===i&&"top"===n),u=s?"pair":"struct",h=s?f("pair"):void 0;return e.map(e=>{var d,o;if(e.id===t){let t=Array.isArray(null===(d=e.meta)||void 0===d?void 0:d.joints)?e.meta.joints:[],n=t.some(e=>e.otherId===a)?t.map(e=>{var t,n;return e.otherId===a?{otherId:a,side:i,t:r,kind:null!==(t=e.kind)&&void 0!==t?t:u,pairId:null!==(n=e.pairId)&&void 0!==n?n:h}:e}):[...t,{otherId:a,side:i,t:r,kind:u,pairId:h}];return{...e,meta:{...e.meta||{},joints:n}}}if(e.id===a){let a=Array.isArray(null===(o=e.meta)||void 0===o?void 0:o.joints)?e.meta.joints:[],i=a.some(e=>e.otherId===t)?a.map(e=>{var a,i;return e.otherId===t?{otherId:t,side:n,t:l,kind:null!==(a=e.kind)&&void 0!==a?a:u,pairId:null!==(i=e.pairId)&&void 0!==i?i:h}:e}):[...a,{otherId:t,side:n,t:l,kind:u,pairId:h}];return{...e,meta:{...e.meta||{},joints:i}}}return e})}),$(null),ea()},eh=(e,t,a)=>{var i,n,r,l;if(ed)return;let d=null!==(n=null===(i=U[e])||void 0===i?void 0:i.fontSize)&&void 0!==n?n:20,o={id:f("el"),type:e,refId:null!=t?t:null,x:null!==(r=null==a?void 0:a.x)&&void 0!==r?r:L?320:120,y:null!==(l=null==a?void 0:a.y)&&void 0!==l?l:120,w:120,h:70,rotation:0,z:j.length,groupId:null,meta:{fontSize:d}};if("WINDOW_SIDE"===e||"WALL_SIDE"===e){o.h=Math.max(24,d+8);let t=j.filter(e=>"STUDENT"===e.type),a=t.length?Math.min(...t.map(e=>e.x)):null,i=t.length?Math.max(...t.map(e=>e.x+e.w)):null,n=t.length?Math.min(...t.map(e=>e.y)):null,r=t.length?Math.max(...t.map(e=>e.y+e.h)):null;o.w=Math.min(Math.max(160,null!==n&&null!==r?Math.max(160,r-n+24):320),Math.max(160,ec.h-24)),o.rotation=90;let l=o.h,s=null!==n&&null!==r?(n+r)/2:ec.h/2;if("WINDOW_SIDE"===e){let e=ec.w-12-l/2;o.x=Math.max(0,Math.min(e,null!==i?i+12+l/2:e)-o.w/2),o.y=Math.max(0,Math.min(ec.h-o.h,s-o.h/2))}else{let e=12+l/2;o.x=Math.max(0,Math.min(ec.w-o.w,Math.max(e,null!==a?a-12-l/2:e)-o.w/2)),o.y=Math.max(0,Math.min(ec.h-o.h,s-o.h/2))}}"DOOR"===e&&(o.w=48,o.h=10),"TEACHER_DESK"===e&&(o.w=260,o.h=80),N(e=>[...e,o]),ea()},em=()=>{if(ed||0===k.length)return;let e=new Set(k);N(t=>t.filter(t=>!e.has(t.id)).map(t=>{var a;let i=Array.isArray(null===(a=t.meta)||void 0===a?void 0:a.joints)?t.meta.joints:[],n=i.filter(t=>!e.has(t.otherId));return n.length!==i.length?{...t,meta:{...t.meta||{},joints:n}}:t})),A([]),ea()},[ec,ef]=(0,n.useState)({w:1200,h:700}),ex=(0,n.useRef)(null);(0,n.useEffect)(()=>{let e=ex.current;if(!e)return;let t=new ResizeObserver(()=>{let t=e.getBoundingClientRect();ef({w:Math.max(600,t.width),h:Math.max(400,t.height)})});return t.observe(e),()=>t.disconnect()},[]);let ep=(0,n.useRef)(null);async function ey(){if(!ep.current)return;let{toPng:e}=await a.e(293).then(a.bind(a,7293)),t=await e(ep.current,{cacheBust:!0,pixelRatio:2}),i=document.createElement("a");i.href=t,i.download="sitzplan-".concat(u,"-").concat(m,".png"),i.click()}async function ev(){if(!ep.current)return;let[{toPng:e},{jsPDF:t}]=await Promise.all([a.e(293).then(a.bind(a,7293)),Promise.all([a.e(505),a.e(65)]).then(a.bind(a,7501))]),i=await e(ep.current,{cacheBust:!0,pixelRatio:2}),n=new t({orientation:"landscape",unit:"pt",format:"a4"}),r=n.internal.pageSize.getWidth(),l=n.internal.pageSize.getHeight(),d=new Image;d.src=i,await new Promise(e=>{d.onload=e});let o=Math.min(r/d.width,l/d.height),s=d.width*o,h=d.height*o;n.addImage(i,"PNG",(r-s)/2,(l-h)/2,s,h),n.save("sitzplan-".concat(u,"-").concat(m,".pdf"))}return(0,n.useEffect)(()=>{let e=e=>{if(X)return;let t=e.target;if(t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable))return;let a=e.ctrlKey||e.metaKey;if(a&&"a"===e.key.toLowerCase()){if(e.preventDefault(),ed)return;A(j.map(e=>e.id).filter(Boolean));return}if(a&&"c"===e.key.toLowerCase()){if(e.preventDefault(),!ei)return;let t=j.find(e=>e.id===ei);t&&P({...t});return}if(a&&"v"===e.key.toLowerCase()){var i,n,r;if(e.preventDefault(),ed||!_)return;let t=null!==(i=null==en?void 0:en.x)&&void 0!==i?i:L?320:120,a=null!==(n=null==en?void 0:en.y)&&void 0!==n?n:120;if("STUDENT"===_.type){let e=new Set(j.filter(e=>"STUDENT"===e.type&&e.refId).map(e=>String(e.refId))),i=E.find(t=>!e.has(String(t.id)));i?eh("STUDENT",i.id,{x:t+16,y:a+16}):eh("STUDENT",void 0,{x:t+16,y:a+16})}else{let e={..._};eh(e.type,null!==(r=e.refId)&&void 0!==r?r:void 0,{x:t+16,y:a+16})}return}if("Delete"===e.key||"Backspace"===e.key){if(ed)return;k.length>0&&(e.preventDefault(),em());return}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[j,en,k,_,ed,E,L,ei]),(0,n.useEffect)(()=>{if(!X)return;let e=()=>F(null);return window.addEventListener("click",e),()=>window.removeEventListener("click",e)},[X]),(0,i.jsx)(c,{ctx:{leadPlan:b,viewMode:I,setViewMode:S,saving:z,frameRef:ex,canvasRef:ep,frameSize:ec,readOnly:ed,elements:j,selectedIds:k,setSelectedIds:A,elementRefs:O,selected:en,studentById:el,defaultTerms:{TEACHER_DESK:"Lehrerpult",DOOR:"T\xfcr",WINDOW_SIDE:"Fenster",WALL_SIDE:"Wand"},pickerOpenId:X,setPickerOpenId:F,pickerQuery:Y,setPickerQuery:Z,usedStudentIds:eo,addElement:eh,applyPairsLayout:()=>{if(ed)return;let e=j.filter(e=>"STUDENT"===e.type),t=E.length,a=Math.max(t,e.length);if(0===a)return;let i=Math.max(1,Math.floor((Math.max(0,ec.w-80)+24)/264)),n=Math.ceil(a/2),r=Math.ceil(n/i),l=[],d=0;for(let e=0;e<r;e++){let t=40,a=60+94*e;for(let e=0;e<i;e++){var o,s;if(d>=n)break;let e={id:f("el"),type:"STUDENT",refId:null,x:t,y:a,w:120,h:70,rotation:0,z:l.length,groupId:null,meta:{fontSize:U.STUDENT.fontSize}},i={id:f("el"),type:"STUDENT",refId:null,x:t+120,y:a,w:120,h:70,rotation:0,z:l.length+1,groupId:null,meta:{fontSize:U.STUDENT.fontSize}},r=(e,t)=>Array.isArray(e)?[...e,t]:[t],u=f("pair");e.meta={...e.meta||{},joints:r(null===(o=e.meta)||void 0===o?void 0:o.joints,{otherId:i.id,side:"right",t:.5,kind:"pair",pairId:u})},i.meta={...i.meta||{},joints:r(null===(s=i.meta)||void 0===s?void 0:s.joints,{otherId:e.id,side:"left",t:.5,kind:"pair",pairId:u})},l.push(e,i),d++,t+=264}}let u=l.map((a,i)=>{var n;return i<t?{...a,refId:E[i].id}:i<e.length?{...a,refId:null!==(n=e[i].refId)&&void 0!==n?n:null}:a});N(e=>[...e.filter(e=>"STUDENT"!==e.type),...u]),ea()},removeJoint:ee,scheduleSave:ea,exportPng:ey,exportPdf:ev,selectedTarget:er,primarySelectedId:ei,moveElementBy:(e,t,a)=>{ed||N(i=>{if(!i.find(t=>t.id===e))return i;let n=new Map(i.map(e=>[e.id,e])),r=[...k.includes(e)?k.slice():[e]],l=new Set;for(;r.length;){var d;let e=r.pop();if(l.has(e))continue;l.add(e);let t=n.get(e);for(let e of Array.isArray(null==t?void 0:null===(d=t.meta)||void 0===d?void 0:d.joints)?t.meta.joints:[])l.has(e.otherId)||r.push(e.otherId)}return i.map(e=>l.has(e.id)?{...e,x:e.x+t,y:e.y+a}:e)})},onDragEnd:(e,t)=>{if(ed)return;let a=j.find(t=>t.id===e),i=e=>{let t=new Map(j.map(e=>[e.id,e])),a=[...e],i=new Set;for(;a.length;){var n;let e=a.pop();if(i.has(e))continue;i.add(e);let r=t.get(e);for(let e of Array.isArray(null==r?void 0:null===(n=r.meta)||void 0===n?void 0:n.joints)?r.meta.joints:[])i.has(e.otherId)||a.push(e.otherId)}return Array.from(i)};if((()=>{var e,t;null==a||a.x,null==a||a.y,a&&(a.x,a.w,a.y,a.h);try{let e=window.__lastMoveableEvent||null;if((null==e?void 0:e.clientX)&&ep.current){let t=ep.current.getBoundingClientRect();e.clientX,t.left,e.clientY,t.top}}catch(e){}})(),a&&("WINDOW_SIDE"===a.type||"WALL_SIDE"===a.type)){let e=j.filter(e=>e.id!==a.id&&("WINDOW_SIDE"===e.type||"WALL_SIDE"===e.type)&&e.type!==a.type),t=null,i=0,n=a.w*a.h;for(let r of e){let e=Math.max(a.x,r.x),l=Math.min(a.x+a.w,r.x+r.w),d=Math.max(a.y,r.y),o=Math.max(0,l-e)*Math.max(0,Math.min(a.y+a.h,r.y+r.h)-d),s=n>0&&r.w*r.h>0?o/Math.min(n,r.w*r.h):0;s>=.5&&s>i&&(i=s,t=r)}if(t){N(e=>e.map(e=>e.id===a.id?{...e,x:t.x,y:t.y,w:t.w,h:t.h,rotation:t.rotation,z:t.z}:e.id===t.id?{...e,x:a.x,y:a.y,w:a.w,h:a.h,rotation:a.rotation,z:a.z}:e)),ea();return}}if(a&&("WINDOW_SIDE"===a.type||"WALL_SIDE"===a.type)){ea();return}if(a&&"STUDENT"===a.type){var n,r,d;let e=e=>{var t;let a=(Array.isArray(null===(t=e.meta)||void 0===t?void 0:t.joints)?e.meta.joints:[]).find(e=>"pair"===e.kind&&"string"==typeof e.otherId);if(a){let e=j.find(e=>e.id===a.otherId)||null;if(e&&"STUDENT"===e.type)return{partner:e,side:a.side,pairId:a.pairId}}let i=null;for(let t of j){if(t.id===e.id||"STUDENT"!==t.type)continue;let a=l({x:e.x,y:e.y,w:e.w,h:e.h},{x:t.x,y:t.y,w:t.w,h:t.h});if(!a)continue;let n=Math.max(Math.max(0,Math.min(e.y+e.h,t.y+t.h)-Math.max(e.y,t.y)),Math.max(0,Math.min(e.x+e.w,t.x+t.w)-Math.max(e.x,t.x)));(!i||n>i.score)&&(i={partner:t,side:a.aSide,score:n})}return i?{partner:i.partner,side:i.side}:null},t=e(a),o=null!==(n=null==t?void 0:t.partner)&&void 0!==n?n:null,s=o?[a.id,o.id]:[a.id],u=i([a.id]),h=j.filter(e=>u.includes(e.id)&&"STUDENT"===e.type).map(e=>e.id),m=j.filter(e=>"STUDENT"===e.type&&!u.includes(e.id)),c=null,f=0,x=a.w*a.h;for(let e of m){let t=Math.max(a.x,e.x),i=Math.min(a.x+a.w,e.x+e.w),n=Math.max(a.y,e.y),r=Math.max(0,i-t)*Math.max(0,Math.min(a.y+a.h,e.y+e.h)-n),l=x>0&&e.w*e.h>0?r/Math.min(x,e.w*e.h):0;l>=.5&&l>f&&(f=l,c=e)}if(c){let t=i([c.id]),n=j.filter(e=>t.includes(e.id)&&"STUDENT"===e.type).map(e=>e.id);if(h.length>1&&h.length===n.length&&((e,t)=>{let a=e=>e.map(e=>j.find(t=>t.id===e)).filter(Boolean).sort((e,t)=>e.y-t.y||e.x-t.x).map(e=>e.id),i=a(e),n=a(t);if(i.length!==n.length)return!1;let r=V.current;return N(e=>{let t=new Map(e.map(e=>{var t;return[e.id,null!==(t=e.refId)&&void 0!==t?t:null]}));return e.map(e=>{var a,l;let d=e,o=i.indexOf(e.id),s=n.indexOf(e.id);return o>=0?d={...d,refId:null!==(a=t.get(n[o]))&&void 0!==a?a:null}:s>=0&&(d={...d,refId:null!==(l=t.get(i[s]))&&void 0!==l?l:null}),r.size>0&&r.has(e.id)&&(d={...d,x:r.get(e.id).x,y:r.get(e.id).y}),d})}),!0})(h,n)){ea();return}if(h.length!==n.length){let e=j.filter(e=>h.includes(e.id)),t=j.filter(e=>n.includes(e.id)),a=e=>e.w*e.h,i=[];for(let n of e)for(let e of t){let t=Math.max(n.x,e.x),r=Math.min(n.x+n.w,e.x+e.w),l=Math.max(n.y,e.y),d=Math.max(0,r-t)*Math.max(0,Math.min(n.y+n.h,e.y+e.h)-l),o=Math.min(a(n),a(e)),s=o>0?d/o:0;s>=.5&&i.push({aId:n.id,bId:e.id,ratio:s})}i.sort((e,t)=>t.ratio-e.ratio);let r=new Set,l=new Set,d=[];for(let e of i)r.has(e.aId)||l.has(e.bId)||(r.add(e.aId),l.add(e.bId),d.push({aId:e.aId,bId:e.bId}));if(d.length>0){(e=>{let t=V.current;N(a=>{let i=new Map(a.map(e=>{var t;return[e.id,null!==(t=e.refId)&&void 0!==t?t:null]})),n=new Map(e.map(e=>[e.aId,e.bId])),r=new Map(e.map(e=>[e.bId,e.aId]));return a.map(e=>{var a,l;let d=e;return n.has(e.id)?d={...d,refId:null!==(a=i.get(n.get(e.id)))&&void 0!==a?a:null}:r.has(e.id)&&(d={...d,refId:null!==(l=i.get(r.get(e.id)))&&void 0!==l?l:null}),t.size>0&&t.has(e.id)&&(d={...d,x:t.get(e.id).x,y:t.get(e.id).y}),d})})})(d),ea();return}}let l=e(c),o=null!==(d=null==l?void 0:l.partner)&&void 0!==d?d:null,u=2===s.length,m=!!o&&(null===(r=j.find(e=>e.id===o.id))||void 0===r?void 0:r.type)==="STUDENT";u&&m?((e,t)=>{let a=e=>{var t;let a=j.find(t=>t.id===e),i=(Array.isArray(null===(t=a.meta)||void 0===t?void 0:t.joints)?a.meta.joints:[]).find(e=>"pair"===e.kind),n=(null==i?void 0:i.side)||"left";return"left"===n||"top"===n?0:1},i=[...e].sort((e,t)=>a(e)-a(t)),n=[...t].sort((e,t)=>a(e)-a(t)),r=V.current;N(e=>{let t=new Map(e.map(e=>{var t;return[e.id,null!==(t=e.refId)&&void 0!==t?t:null]}));return e.map(e=>{var a,l,d,o;let s=e;return e.id===i[0]?s={...s,refId:null!==(a=t.get(n[0]))&&void 0!==a?a:null}:e.id===i[1]?s={...s,refId:null!==(l=t.get(n[1]))&&void 0!==l?l:null}:e.id===n[0]?s={...s,refId:null!==(d=t.get(i[0]))&&void 0!==d?d:null}:e.id===n[1]&&(s={...s,refId:null!==(o=t.get(i[1]))&&void 0!==o?o:null}),r.size>0&&r.has(e.id)&&(s={...s,x:r.get(e.id).x,y:r.get(e.id).y}),s})})})(s,[c.id,o.id]):((e,t)=>{let a=V.current;N(i=>{let n=new Map(i.map(e=>{var t;return[e.id,null!==(t=e.refId)&&void 0!==t?t:null]}));return i.map(i=>{var r,l;let d=i;return i.id===e?d={...d,refId:null!==(r=n.get(t))&&void 0!==r?r:null}:i.id===t&&(d={...d,refId:null!==(l=n.get(e))&&void 0!==l?l:null}),a.size>0&&a.has(i.id)&&(d={...d,x:a.get(i.id).x,y:a.get(i.id).y}),d})})})(a.id,c.id),ea();return}}N(a=>{let i=a.find(t=>t.id===e);if(!i)return a;if(null==t?void 0:t.detach)return setTimeout(()=>{for(let t of a)t.id!==e&&ee(e,t.id);ea()},0),a;let n=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,i=null;for(let n of t){if(x(e.y,e.y+e.h,n.y,n.y+n.h)>0){let t=n.x-e.x;Math.abs(t)<=a&&(i=!i||Math.abs(t)<Math.hypot(i.dx,i.dy)?{dx:t,dy:0}:i);let r=n.x+n.w-(e.x+e.w);Math.abs(r)<=a&&(i=!i||Math.abs(r)<Math.hypot(i.dx,i.dy)?{dx:r,dy:0}:i);let l=n.x-(e.x+e.w);Math.abs(l)<=a&&(i=!i||Math.abs(l)<Math.hypot(i.dx,i.dy)?{dx:l,dy:0}:i);let d=n.x+n.w-e.x;Math.abs(d)<=a&&(i=!i||Math.abs(d)<Math.hypot(i.dx,i.dy)?{dx:d,dy:0}:i)}if(x(e.x,e.x+e.w,n.x,n.x+n.w)>0){let t=n.y-e.y;Math.abs(t)<=a&&(i=!i||Math.abs(t)<Math.hypot(i.dx,i.dy)?{dx:0,dy:t}:i);let r=n.y+n.h-(e.y+e.h);Math.abs(r)<=a&&(i=!i||Math.abs(r)<Math.hypot(i.dx,i.dy)?{dx:0,dy:r}:i);let l=n.y-(e.y+e.h);Math.abs(l)<=a&&(i=!i||Math.abs(l)<Math.hypot(i.dx,i.dy)?{dx:0,dy:l}:i);let d=n.y+n.h-e.y;Math.abs(d)<=a&&(i=!i||Math.abs(d)<Math.hypot(i.dx,i.dy)?{dx:0,dy:d}:i)}}return i}(i,a.filter(t=>t.id!==e),8),r=i;n&&(r={...i,x:i.x+n.dx,y:i.y+n.dy});let d=new Map(a.map(e=>[e.id,e])),o=[e],s=new Set;for(;o.length;){var u;let e=o.pop();if(s.has(e))continue;s.add(e);let t=d.get(e);for(let e of Array.isArray(null==t?void 0:null===(u=t.meta)||void 0===u?void 0:u.joints)?t.meta.joints:[])!s.has(e.otherId)&&d.has(e.otherId)&&o.push(e.otherId)}let h=Array.from(s),m=new Map;for(let t of h){let i=t===e?r:d.get(t);if(!i)continue;let n=null,o=-1/0;for(let e of a){if(s.has(e.id)||!p(i,e)||!l({x:i.x,y:i.y,w:i.w,h:i.h},{x:e.x,y:e.y,w:e.w,h:e.h}))continue;let t=Math.max(Math.max(0,Math.min(i.y+i.h,e.y+e.h)-Math.max(i.y,e.y)),Math.max(0,Math.min(i.x+i.w,e.x+e.w)-Math.max(i.x,e.x)));t>o&&(o=t,n=e)}if(n){let e=l({x:i.x,y:i.y,w:i.w,h:i.h},{x:n.x,y:n.y,w:n.w,h:n.h});if(e){let a=n,r=i.x,l=i.y;"right"===e.aSide&&"left"===e.bSide?(r=a.x-i.w,l=a.y+e.bT*a.h-e.aT*i.h):"left"===e.aSide&&"right"===e.bSide?(r=a.x+a.w,l=a.y+e.bT*a.h-e.aT*i.h):"bottom"===e.aSide&&"top"===e.bSide?(l=a.y-i.h,r=a.x+e.bT*a.w-e.aT*i.w):"top"===e.aSide&&"bottom"===e.bSide&&(l=a.y+a.h,r=a.x+e.bT*a.w-e.aT*i.w),m.set(t,{x:r,y:l})}}}return a.map(t=>{if(t.id===e){let t=m.get(e);return t?{...r,x:t.x,y:t.y}:{...r}}if(m.has(t.id)){let e=m.get(t.id);return{...t,x:e.x,y:e.y}}return t})}),ea()},setElements:N,students:E,classId:u,roomId:m,loadPlan:et,setMarquee:H,marquee:B,editing:J,setEditing:q,detachOnDragRef:G,dragStartPositions:V,sidebarOpen:L,activeProfile:o,setTypeStyles:K,removeSelected:em,setStudents:D,tryCreateJointAt:(e,t)=>{let a=es(e,t);return!!a&&(eu(a),!0)},updateJointHover:(e,t)=>{let a=es(e,t);return $(a),!!a},jointHover:Q,setJointHover:$,createJointFromCandidate:eu,onInlineEditKeyDown:async(e,t)=>{if("Escape"===t.key){q({id:null,value:""});return}if("Enter"===t.key){let t=J.value.trim();if(!t){q({id:null,value:""});return}if("STUDENT"===e.type&&e.refId)try{await fetch("/api/students/".concat(e.refId),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({foreName:t})}),D(a=>a.map(a=>a.id===e.refId?{...a,foreName:t}:a))}catch(e){}else N(a=>a.map(a=>a.id===e.id?{...a,meta:{...a.meta||{},label:t}}:a)),ea();q({id:null,value:""})}},onInlineEditBlur:async e=>{let t=J.value.trim();if(q({id:null,value:""}),t){if("STUDENT"===e.type&&e.refId)try{await fetch("/api/students/".concat(e.refId),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({foreName:t})}),D(a=>a.map(a=>a.id===e.refId?{...a,foreName:t}:a))}catch(e){}else N(a=>a.map(a=>a.id===e.id?{...a,meta:{...a.meta||{},label:t}}:a)),ea()}},onMoveableResize:e=>{if(!ei)return;let{width:t,height:a,drag:i,direction:n}=e;N(e=>e.map(e=>{var r,l,d,o,s;if(e.id!==ei)return e;let u=Math.max(10,t),h=Math.max(10,a);("DOOR"===e.type||"WINDOW_SIDE"===e.type||"WALL_SIDE"===e.type)&&(Math.round((e.rotation%360+360)%360/90)%2==0?h=e.h:u=e.w);let m=e.x+(null!==(o=null==i?void 0:null===(r=i.beforeTranslate)||void 0===r?void 0:r[0])&&void 0!==o?o:0),c=e.y+(null!==(s=null==i?void 0:null===(l=i.beforeTranslate)||void 0===l?void 0:l[1])&&void 0!==s?s:0),f=u-e.w,x=h-e.h,p=Array.isArray(n)?n[0]:0,y=Array.isArray(n)?n[1]:0;if((0!==f||0!==x)&&Array.isArray(null===(d=e.meta)||void 0===d?void 0:d.joints)){let t=e.meta.joints;setTimeout(()=>{N(e=>e.map(e=>{let a=t.find(t=>t.otherId===e.id);return a?1===p&&"right"===a.side?{...e,x:e.x+f}:-1===p&&"left"===a.side?{...e,x:e.x-f}:1===y&&"bottom"===a.side?{...e,y:e.y+x}:-1===y&&"top"===a.side?{...e,y:e.y-x}:e:e}))},0)}return{...e,w:u,h:h,x:m,y:c}}))}}})}},4308:function(e,t,a){"use strict";a.d(t,{z:function(){return n}});var i=a(7437);function n(e){let{variant:t="ghost",className:a="",...n}=e;return(0,i.jsx)("button",{className:"".concat("inline-flex items-center rounded px-3 py-2 text-sm transition-colors"," ").concat({primary:"bg-primary/20 text-primary hover:bg-primary/30",ghost:"bg-neutral-800 text-fg hover:bg-neutral-700",danger:"bg-red-900/40 text-red-300 hover:bg-red-900/60"}[t]," ").concat(a),...n})}a(2265)},8334:function(e,t,a){"use strict";a.d(t,{Z:function(){return i}});let i={modal:1e3,dropdown:950,toolbar:900,overlay:800}}}]);